<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shape Fit - Avaliação física inteligente</title>
    <meta name="description" content="Sistema profissional de avaliação física e acompanhamento de clientes">
    <meta name="keywords" content="avaliação física, personal trainer, fitness, composição corporal">

    <!-- Open Graph (para Facebook, Instagram e WhatsApp) -->
    <meta property="og:title" content="Shape Fit - Avaliação física inteligente">
    <meta property="og:description" content="Sistema profissional de avaliação física e acompanhamento de clientes">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://shapefit01.netlify.app"> <!-- Substitua pela URL real -->
    <meta property="og:image" content="https://shapefit01.netlify.app/images/meta.jpg"> <!-- Substitua pela imagem real -->

    <!-- Meta para WhatsApp (usa Open Graph) -->
    <meta name="theme-color" content="#4CAF50"> <!-- Cor do destaque da aba no WhatsApp Android -->
    <meta property="og:locale" content="pt_BR">

    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1B5E20',
                        secondary: '#F8F9FA',
                        dark: '#263238',
                        accent: '#1B5E20'
                    },
                    animation: {
                        fadeIn: 'fadeIn 0.3s ease-in',
                        slideIn: 'slideIn 0.4s ease-out',
                        pulse: 'pulse 2s infinite'
                    }
                }
            }
        }
    </script>

    <style>
        .dark {
            --bg-primary: #263238;
            --bg-secondary: #1a1a1a;
            --text-primary: #F8F9FA;
            --accent: #1B5E20;
        }
        
        .light {
            --bg-primary: #F8F9FA;
            --bg-secondary: #ffffff;
            --text-primary: #263238;
            --accent: #1B5E20;
        }

        :root {
            --sidebar-width: 250px;
            --topbar-height: 64px;
        }

        body {
            transition: background-color 0.3s ease;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            background-image: url('images/back.jpg');
            background-size: contain;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(27, 94, 32, 0.1);
            z-index: -1;
        }

        /* Auth Screen Styles */
        #auth-screen {
            position: relative;
            z-index: 1;
        }

        #auth-screen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(27, 94, 32, 0.9), rgba(21, 76, 26, 0.9));
            z-index: -1;
        }

        /* App visibility states */
        #auth-screen.hidden,
        #main-app.hidden {
            display: none !important;
        }

        .bg-primary {
            background-color: var(--bg-primary);
            backdrop-filter: blur(10px);
            background: rgba(27, 94, 32, 0.95);
        }

        .bg-secondary {
            background-color: var(--bg-secondary);
            backdrop-filter: blur(15px);
            background: rgba(248, 249, 250, 0.95);
        }

        .dark .bg-secondary {
            background: rgba(38, 50, 56, 0.95);
        }

        .sidebar {
            width: var(--sidebar-width);
            transition: transform 0.3s ease;
            background: rgba(27, 94, 32, 0.98);
            backdrop-filter: blur(15px);
        }

        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                position: fixed;
                z-index: 40;
                height: 100%;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0 !important;
                width: 100% !important;
            }
        }

        .main-content {
            margin-left: var(--sidebar-width);
            width: calc(100% - var(--sidebar-width));
            transition: margin-left 0.3s ease, width 0.3s ease;
        }

        @media (max-width: 1024px) {
            .main-content {
                margin-left: 0;
                width: 100%;
            }
        }

        .chart-container {
            height: 300px;
            position: relative;
        }

        .input-field {
            transition: all 0.3s ease;
        }

        .input-field:focus-within {
            border-color: #1B5E20;
        }

        .input-field input:focus {
            outline: none;
        }

        .tab {
            display: none;
        }

        .tab.active {
            display: block;
        }

        .app-section {
            display: none;
        }

        .app-section.active {
            display: block;
        }

        .logo-container {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1B5E20, #2E7D32);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(27, 94, 32, 0.3);
            margin: 0 auto 1rem;
            overflow: hidden;
            position: relative;
        }

        .logo-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .logo-text {
            color: white;
            font-size: 28px;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .sidebar .logo-container {
            width: 60px;
            height: 60px;
        }

        .sidebar .logo-text {
            font-size: 24px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: rgba(248, 249, 250, 0.98);
            backdrop-filter: blur(15px);
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
        }

        .dark .modal-content {
            background: rgba(38, 50, 56, 0.98);
        }

        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background: rgba(46, 125, 50, 0.98);
            backdrop-filter: blur(15px);
        }

        .card-blur {
            background: rgba(248, 249, 250, 0.98);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .dark .card-blur {
            background: rgba(38, 50, 56, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .protocol-tabs {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            padding: 12px 16px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            animation: slideInRight 0.3s ease-out;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            background-color: #10b981;
        }

        .notification.error {
            background-color: #ef4444;
        }

        .notification.warning {
            background-color: #f59e0b;
        }

        .notification.info {
            background-color: #3b82f6;
        }

        .animate-fadeIn {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
        }

        .calendar-day {
            min-height: 120px;
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
            padding: 8px;
            cursor: pointer;
        }

        .calendar-day:hover {
            background-color: #f3f4f6;
        }

        .calendar-day.today {
            background-color: #dcfce7;
            border-color: #16a34a;
        }

        .dark .calendar-day {
            border-color: #374151;
        }

        .dark .calendar-day:hover {
            background-color: #374151;
        }

        .dark .calendar-day.today {
            background-color: #14532d;
            border-color: #22c55e;
        }

        .btn-hover-lift {
            transition: all 0.2s ease;
        }

        .btn-hover-lift:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Loading overlay */
        #loading-overlay {
            display: none;
        }

        #loading-overlay.show {
            display: flex;
        }

        /* Client detail tabs */
        .client-tab {
            display: none;
        }

        .client-tab.active {
            display: block;
        }

        /* Exercise selection */
        .exercise-item {
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .exercise-item:hover {
            background-color: #f3f4f6;
        }

        .dark .exercise-item:hover {
            background-color: #374151;
        }

        .exercise-item.selected {
            background-color: #dcfce7;
            border-color: #16a34a;
        }

        .dark .exercise-item.selected {
            background-color: #14532d;
            border-color: #22c55e;
        }

        /* Profile image upload */
        .profile-image-upload {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }

        .profile-image-upload input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .profile-image-upload .upload-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            border-radius: 50%;
        }

        .profile-image-upload:hover .upload-overlay {
            opacity: 1;
        }

        .image-upload-area {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }

        .image-upload-area:hover .upload-overlay {
            opacity: 1;
        }

        .upload-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        /* Image gallery */
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
        }

        .image-gallery-item {
            position: relative;
            aspect-ratio: 3/4;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
        }

        .image-gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-gallery-item .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .image-gallery-item:hover .delete-btn {
            opacity: 1;
        }

        .add-image-btn {
            aspect-ratio: 3/4;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-image-btn:hover {
            border-color: #2E7D43;
            background-color: rgba(231, 20, 20, 0.05);
        }

        .exercise-database {
            max-height: 300px;
            overflow-y: auto;
        }

        .exercise-category {
            margin-bottom: 1rem;
        }

        @media (max-width: 640px) {
            .sidebar {
                width: 100%;
            }
            
            .protocol-tabs {
                padding-bottom: 8px;
            }
            
            .calendar-day {
                min-height: 80px;
                padding: 4px;
            }
            
            .chart-container {
                height: 250px;
            }
            
            .logo-container {
                width: 70px;
                height: 70px;
            }
            
            .logo-text {
                font-size: 24px;
            }

            .image-gallery {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }

        /* WhatsApp Button Style */
        .whatsapp-link {
            background: linear-gradient(135deg, #25d366, #128c7e);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            padding: 8px 12px;
            display: inline-flex;
            align-items: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(37, 211, 102, 0.3);
        }

        .whatsapp-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4);
            color: white;
        }

        .whatsapp-link i {
            margin-right: 6px;
        }

        /* Loading animation */
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2E7D43;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Recent Activities Styles */
        .activity-list {
            max-height: 300px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #1B5E20 transparent;
        }

        .activity-list::-webkit-scrollbar {
            width: 4px;
        }

        .activity-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .activity-list::-webkit-scrollbar-thumb {
            background: #1B5E20;
            border-radius: 2px;
        }

        .activity-item {
            opacity: 0;
            animation: fadeInUp 0.3s ease-out forwards;
        }

        .activity-item:nth-child(1) { animation-delay: 0.1s; }
        .activity-item:nth-child(2) { animation-delay: 0.2s; }
        .activity-item:nth-child(3) { animation-delay: 0.3s; }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="light">
    <div id="auth-screen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-green-400 to-green-600">
        <div class="max-w-md w-full mx-4">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8">
                <div class="text-center mb-8">
                    <div class="logo-container mx-auto mb-4">
                        <img id="login-logo" src="images/logo.jpg" alt="Shape Fit Logo" style="display: none;" 
                             onload="this.style.display='block'; this.nextElementSibling.style.display='none';"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <span class="logo-text">SF</span>
                    </div>
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100">Shape Fit</h1>
                    <p class="text-gray-600 dark:text-gray-400">Avaliação física inteligente</p>
                </div>

                <div class="flex mb-6 bg-gray-100 dark:bg-gray-700 rounded-lg p-1">
                    <button id="login-tab" class="flex-1 py-2 px-4 rounded-md text-sm font-medium bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 shadow">
                        Entrar
                    </button>
                    <button id="register-tab" class="flex-1 py-2 px-4 rounded-md text-sm font-medium text-gray-600 dark:text-gray-400 opacity-50 cursor-not-allowed" disabled>
                        Cadastrar (Em breve)
                    </button>
                </div>

                <form id="login-form" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email</label>
                        <input type="email" id="login-email" class="w-full px-3 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 dark:bg-gray-700 dark:text-gray-100 text-base" placeholder="seu@email.com" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Senha</label>
                        <input type="password" id="login-password" class="w-full px-3 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 dark:bg-gray-700 dark:text-gray-100 text-base" placeholder="••••••••" required>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <input type="checkbox" id="remember-me" class="h-4 w-4 text-green-600 rounded">
                            <label for="remember-me" class="ml-2 text-sm text-gray-600 dark:text-gray-400">Lembrar de mim</label>
                        </div>
                        <a href="https://wa.me/5582996092684?text=Olá! Esqueci minha senha do Shape Fit e preciso de ajuda para recuperar o acesso." target="_blank" class="text-sm whatsapp-link">
                            <i class="fab fa-whatsapp"></i>
                            Esqueci a senha
                        </a>
                    </div>
                    <button type="submit" id="login-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                        <span id="login-btn-text">Entrar</span>
                        <div id="login-spinner" class="loading-spinner ml-2" style="display: none;"></div>
                    </button>
                    <div class="text-center">
                        <p class="text-sm text-gray-600 dark:text-gray-400">
                            Não tem conta? 
                            <a href="https://wa.me/5582996092684?text=Olá! Gostaria de solicitar acesso ao sistema Shape Fit." target="_blank" class="whatsapp-link">
                                <i class="fab fa-whatsapp"></i>
                                Solicitar acesso
                            </a>
                        </p>
                    </div>
                </form>

                <div id="login-error" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded hidden">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        <span id="login-error-message">Erro no login</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                <div class="flex items-center space-x-3">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-accent"></div>
                    <span class="text-lg font-medium">Carregando dados...</span>
                </div>
            </div>
        </div>

        <div class="sidebar shadow-lg fixed top-0 left-0 h-full z-40">
            <div class="p-4 flex flex-col h-full">
                <div class="flex flex-col items-center justify-center mb-8">
                    <div class="logo-container">
                        <img id="sidebar-logo" src="images/logo.jpg" alt="Shape Fit Logo" style="display: none;"
                             onload="this.style.display='block'; this.nextElementSibling.style.display='none';"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <span class="logo-text">SF</span>
                    </div>
                    <div class="text-center">
                        <h1 class="text-2xl font-bold text-white">Shape Fit</h1>
                        <p class="text-sm text-green-100">Avaliação física inteligente</p>
                    </div>
                    <button id="close-sidebar" class="lg:hidden text-white absolute top-4 right-4">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <nav class="flex-grow">
                    <ul class="space-y-2">
                        <li>
                            <a href="#" id="nav-dashboard" class="nav-link flex items-center space-x-3 p-3 rounded-lg text-white hover:bg-green-600 transition bg-green-700">
                                <i class="fas fa-tachometer-alt"></i>
                                <span>Dashboard</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" id="nav-calculator" class="nav-link flex items-center space-x-3 p-3 rounded-lg text-white hover:bg-green-600 transition">
                                <i class="fas fa-calculator"></i>
                                <span>Calculadora</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" id="nav-clients" class="nav-link flex items-center space-x-3 p-3 rounded-lg text-white hover:bg-green-600 transition">
                                <i class="fas fa-users"></i>
                                <span>Clientes</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" id="nav-evaluations" class="nav-link flex items-center space-x-3 p-3 rounded-lg text-white hover:bg-green-600 transition">
                                <i class="fas fa-clipboard-check"></i>
                                <span>Avaliações</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" id="nav-workouts" class="nav-link flex items-center space-x-3 p-3 rounded-lg text-white hover:bg-green-600 transition">
                                <i class="fas fa-dumbbell"></i>
                                <span>Treinos</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" id="nav-schedule" class="nav-link flex items-center space-x-3 p-3 rounded-lg text-white hover:bg-green-600 transition">
                                <i class="fas fa-calendar-alt"></i>
                                <span>Agenda</span>
                            </a>
                        </li>
                    </ul>
                </nav>
                
                <div class="pt-4 border-t border-green-400">
                    <a href="#" id="settings-btn" class="flex items-center space-x-3 p-3 rounded-lg text-white hover:bg-green-600 transition">
                        <i class="fas fa-cog"></i>
                        <span>Configurações</span>
                    </a>
                    <a href="#" id="logout-btn" class="flex items-center space-x-3 p-3 rounded-lg text-white hover:bg-green-600 transition">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Sair</span>
                    </a>
                </div>
            </div>
        </div>

        <div class="main-content min-h-screen">
            <header class="sticky-header shadow-md h-16 flex items-center justify-between px-4">
                <div class="flex items-center">
                    <button id="toggle-sidebar" class="lg:hidden mr-4 text-white">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h2 id="page-title" class="text-xl font-semibold text-white">Dashboard</h2>
                </div>
                
                <div class="flex items-center space-x-2 md:space-x-4">
                    <button id="theme-toggle" class="p-2 rounded-full text-white hover:bg-green-600 transition">
                        <i class="fas fa-moon"></i>
                    </button>
                    <div class="flex items-center space-x-2">
                        <img id="user-avatar" src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?ixlib=rb-4.0.3&auto=format&fit=facearea&facepad=2&w=40&h=40&q=80" alt="Perfil" class="w-8 h-8 rounded-full">
                        <span id="user-name" class="hidden md:inline text-white">Personal Trainer</span>
                    </div>
                </div>
            </header>

            <section id="section-dashboard" class="app-section active p-4 md:p-6 animate-fadeIn">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="card-blur p-4 rounded-lg shadow-md">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-80">Total de Clientes</p>
                                <h3 class="text-2xl font-bold" id="total-clients-stat">0</h3>
                            </div>
                            <div class="bg-blue-100 p-3 rounded-full text-blue-600">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        <p class="text-xs mt-2 text-gray-500"><i class="fas fa-plus"></i> Comece adicionando clientes</p>
                    </div>
                    
                    <div class="card-blur p-4 rounded-lg shadow-md">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-80">Avaliações (mês)</p>
                                <h3 class="text-2xl font-bold" id="total-evaluations-stat">0</h3>
                            </div>
                            <div class="bg-green-100 p-3 rounded-full text-green-600">
                                <i class="fas fa-clipboard-check"></i>
                            </div>
                        </div>
                        <p class="text-xs mt-2 text-gray-500"><i class="fas fa-calculator"></i> Use a calculadora</p>
                    </div>
                    
                    <div class="card-blur p-4 rounded-lg shadow-md">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-80">Treinos Ativos</p>
                                <h3 class="text-2xl font-bold" id="total-workouts-stat">0</h3>
                            </div>
                            <div class="bg-purple-100 p-3 rounded-full text-purple-600">
                                <i class="fas fa-dumbbell"></i>
                            </div>
                        </div>
                        <p class="text-xs mt-2 text-gray-500"><i class="fas fa-plus"></i> Crie seu primeiro treino</p>
                    </div>
                    
                    <div class="card-blur p-4 rounded-lg shadow-md">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-80">Agendamentos</p>
                                <h3 class="text-2xl font-bold" id="total-appointments-stat">0</h3>
                            </div>
                            <div class="bg-yellow-100 p-3 rounded-full text-yellow-600">
                                <i class="fas fa-calendar"></i>
                            </div>
                        </div>
                        <p class="text-xs mt-2 text-gray-500"><i class="fas fa-calendar-plus"></i> Organize sua agenda</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="card-blur p-4 rounded-lg shadow-md lg:col-span-2">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-semibold text-gray-900">Evolução de Clientes</h3>
                            <select id="chart-period" class="bg-gray-50 dark:bg-gray-700 rounded-md border-none text-sm p-1">
                                <option value="6">Últimos 6 meses</option>
                                <option value="12">Último ano</option>
                                <option value="all">Todos os tempos</option>
                            </select>
                        </div>
                        <div class="chart-container">
                            <canvas id="evolutionChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="card-blur p-4 rounded-lg shadow-md">
                        <h3 class="font-semibold mb-4 text-gray-900">Atividades Recentes</h3>
                        <ul class="activity-list space-y-3" id="recent-activities">
                            <li class="text-center py-4 text-gray-500">
                                <div class="text-2xl mb-2"><i class="fas fa-clock"></i></div>
                                <p class="text-sm">Nenhuma atividade recente</p>
                            </li>
                        </ul>
                    </div>
                </div>
            </section>

            <section id="section-calculator" class="app-section p-4 md:p-6 animate-fadeIn">
                <div class="max-w-7xl mx-auto">
                    <header class="mb-6">
                        <h1 class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-gray-100">Avaliação de Composição Corporal</h1>
                    </header>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 card-blur rounded-lg shadow-md p-6">
                            <div class="mb-6 border-b protocol-tabs">
                                <div class="flex -mb-px overflow-x-auto">
                                    <button id="tab-jp3" class="protocol-tab inline-block p-3 text-green-600 border-b-2 border-green-600 active whitespace-nowrap text-sm" data-protocol="jp3">
                                        Jackson-Pollock 3 Dobras
                                    </button>
                                    <button id="tab-jp7" class="protocol-tab inline-block p-3 text-gray-500 dark:text-gray-300 hover:text-gray-600 dark:hover:text-gray-200 border-b-2 border-transparent hover:border-gray-300 whitespace-nowrap text-sm" data-protocol="jp7">
                                        Jackson-Pollock 7 Dobras
                                    </button>
                                    <button id="tab-faulkner" class="protocol-tab inline-block p-3 text-gray-500 dark:text-gray-300 hover:text-gray-600 dark:hover:text-gray-200 border-b-2 border-transparent hover:border-gray-300 whitespace-nowrap text-sm" data-protocol="faulkner">
                                        Faulkner
                                    </button>
                                    <button id="tab-durnin" class="protocol-tab inline-block p-3 text-gray-500 dark:text-gray-300 hover:text-gray-600 dark:hover:text-gray-200 border-b-2 border-transparent hover:border-gray-300 whitespace-nowrap text-sm" data-protocol="durnin">
                                        Durnin & Womersley
                                    </button>
                                    <button id="tab-petroski" class="protocol-tab inline-block p-3 text-gray-500 dark:text-gray-300 hover:text-gray-600 dark:hover:text-gray-200 border-b-2 border-transparent hover:border-gray-300 whitespace-nowrap text-sm" data-protocol="petroski">
                                        Petroski
                                    </button>
                                    <button id="tab-guedes" class="protocol-tab inline-block p-3 text-gray-500 dark:text-gray-300 hover:text-gray-600 dark:hover:text-gray-200 border-b-2 border-transparent hover:border-gray-300 whitespace-nowrap text-sm" data-protocol="guedes">
                                        Guedes
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Cliente</label>
                                    <select id="client" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 rounded-lg p-2.5 text-base">
                                        <option value="" selected>Selecione o cliente</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Sexo</label>
                                    <div class="flex space-x-4 pt-2">
                                        <div class="flex items-center">
                                            <input id="gender-male" type="radio" name="gender" value="male" class="w-4 h-4 text-green-600 bg-gray-100 border-gray-300" checked>
                                            <label for="gender-male" class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-100">Masculino</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input id="gender-female" type="radio" name="gender" value="female" class="w-4 h-4 text-green-600 bg-gray-100 border-gray-300">
                                            <label for="gender-female" class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-100">Feminino</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <label for="age" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Idade</label>
                                    <div class="input-field flex border border-gray-300 dark:border-gray-600 rounded-lg overflow-hidden">
                                        <input type="number" id="age" class="p-2.5 flex-1 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 text-base" placeholder="Anos" min="10" max="120">
                                        <span class="bg-gray-100 dark:bg-gray-600 text-gray-500 dark:text-gray-300 font-medium px-3 inline-flex items-center">anos</span>
                                    </div>
                                </div>
                                
                                <div>
                                    <label for="weight" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Peso</label>
                                    <div class="input-field flex border border-gray-300 dark:border-gray-600 rounded-lg overflow-hidden">
                                        <input type="number" id="weight" step="0.1" class="p-2.5 flex-1 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 text-base" placeholder="Kg" min="20" max="300">
                                        <span class="bg-gray-100 dark:bg-gray-600 text-gray-500 dark:text-gray-300 font-medium px-3 inline-flex items-center">kg</span>
                                    </div>
                                </div>
                                
                                <div>
                                    <label for="height" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Altura</label>
                                    <div class="input-field flex border border-gray-300 dark:border-gray-600 rounded-lg overflow-hidden">
                                        <input type="number" id="height" step="0.01" class="p-2.5 flex-1 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 text-base" placeholder="1.70" min="1.00" max="2.50">
                                        <span class="bg-gray-100 dark:bg-gray-600 text-gray-500 dark:text-gray-300 font-medium px-3 inline-flex items-center">m</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Protocol Forms -->
                            <div id="form-jp3" class="protocol-form">
                                <h3 class="font-medium text-lg mb-4 text-gray-800 dark:text-gray-200">Protocolo Jackson-Pollock 3 Dobras</h3>
                                
                                <div class="text-sm text-gray-600 dark:text-gray-300 mb-4 bg-green-50 dark:bg-green-900/30 p-3 rounded-lg">
                                    <p class="font-medium">Instruções para medição:</p>
                                    <p>• Use um adipômetro calibrado</p>
                                    <p>• Realize cada medida 3 vezes e utilize a média</p>
                                    <p>• Homens: peitoral, abdômen e coxa</p>
                                    <p>• Mulheres: tríceps, suprailíaca e coxa</p>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4" id="jp3-fields">
                                    <!-- Fields will be dynamically added based on gender -->
                                </div>
                            </div>

                            <div id="form-jp7" class="protocol-form hidden">
                                <h3 class="font-medium text-lg mb-4 text-gray-800 dark:text-gray-200">Protocolo Jackson-Pollock 7 Dobras</h3>
                                
                                <div class="text-sm text-gray-600 dark:text-gray-300 mb-4 bg-green-50 dark:bg-green-900/30 p-3 rounded-lg">
                                    <p class="font-medium">Instruções para medição:</p>
                                    <p>• Use um adipômetro calibrado</p>
                                    <p>• Realize cada medida 3 vezes e utilize a média</p>
                                    <p>• Medidas: peitoral, axilar média, tríceps, subescapular, abdômen, suprailíaca e coxa</p>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4" id="jp7-fields">
                                    <!-- 7 fields for JP7 protocol -->
                                </div>
                            </div>

                            <div id="form-faulkner" class="protocol-form hidden">
                                <h3 class="font-medium text-lg mb-4 text-gray-800 dark:text-gray-200">Protocolo Faulkner</h3>
                                
                                <div class="text-sm text-gray-600 dark:text-gray-300 mb-4 bg-green-50 dark:bg-green-900/30 p-3 rounded-lg">
                                    <p class="font-medium">Instruções para medição:</p>
                                    <p>• Use um adipômetro calibrado</p>
                                    <p>• Medidas: tríceps, subescapular, suprailíaca e abdômen</p>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4" id="faulkner-fields">
                                    <!-- 4 fields for Faulkner protocol -->
                                </div>
                            </div>

                            <div id="form-durnin" class="protocol-form hidden">
                                <h3 class="font-medium text-lg mb-4 text-gray-800 dark:text-gray-200">Protocolo Durnin & Womersley</h3>
                                
                                <div class="text-sm text-gray-600 dark:text-gray-300 mb-4 bg-green-50 dark:bg-green-900/30 p-3 rounded-lg">
                                    <p class="font-medium">Instruções para medição:</p>
                                    <p>• Use um adipômetro calibrado</p>
                                    <p>• Medidas: bíceps, tríceps, subescapular e suprailíaca</p>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4" id="durnin-fields">
                                    <!-- 4 fields for Durnin protocol -->
                                </div>
                            </div>

                            <div id="form-petroski" class="protocol-form hidden">
                                <h3 class="font-medium text-lg mb-4 text-gray-800 dark:text-gray-200">Protocolo Petroski</h3>
                                
                                <div class="text-sm text-gray-600 dark:text-gray-300 mb-4 bg-green-50 dark:bg-green-900/30 p-3 rounded-lg">
                                    <p class="font-medium">Instruções para medição:</p>
                                    <p>• Protocolo específico para brasileiros</p>
                                    <p>• Homens: peitoral, abdômen e coxa</p>
                                    <p>• Mulheres: tríceps, suprailíaca e coxa</p>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4" id="petroski-fields">
                                    <!-- Fields will be dynamically added based on gender -->
                                </div>
                            </div>

                            <div id="form-guedes" class="protocol-form hidden">
                                <h3 class="font-medium text-lg mb-4 text-gray-800 dark:text-gray-200">Protocolo Guedes</h3>
                                
                                <div class="text-sm text-gray-600 dark:text-gray-300 mb-4 bg-green-50 dark:bg-green-900/30 p-3 rounded-lg">
                                    <p class="font-medium">Instruções para medição:</p>
                                    <p>• Protocolo para crianças e adolescentes</p>
                                    <p>• Medidas: tríceps e subescapular</p>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4" id="guedes-fields">
                                    <!-- 2 fields for Guedes protocol -->
                                </div>
                            </div>
                            
                            <div class="mt-6">
                                <button id="calculate-btn" class="w-full bg-accent hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg transition btn-hover-lift">
                                    <i class="fas fa-calculator mr-2"></i>
                                    Calcular Composição Corporal
                                </button>
                            </div>
                        </div>
                        
                        <div class="result-card card-blur rounded-lg shadow-md p-6">
                            <h3 class="font-medium text-lg mb-4 text-gray-800 dark:text-gray-200">Resultados</h3>
                            
                            <div id="results-empty" class="text-center py-10">
                                <div class="text-gray-400 mb-3">
                                    <i class="fas fa-calculator text-5xl"></i>
                                </div>
                                <p class="text-gray-500 dark:text-gray-400">Preencha os dados e clique em calcular para ver os resultados</p>
                            </div>
                            
                            <div id="results-content" class="hidden">
                                <div class="mb-6 text-center">
                                    <div class="relative inline-flex items-center justify-center">
                                        <svg class="w-32 h-32">
                                            <circle class="text-gray-200 dark:text-gray-700" stroke-width="10" stroke="currentColor" fill="transparent" r="58" cx="64" cy="64"></circle>
                                            <circle id="result-circle" class="text-accent" stroke-width="10" stroke="currentColor" stroke-linecap="round" fill="transparent" r="58" cx="64" cy="64" stroke-dasharray="364.4" stroke-dashoffset="364.4" style="transition: stroke-dashoffset 0.5s ease;"></circle>
                                        </svg>
                                        <div class="absolute">
                                            <div class="text-3xl font-bold text-gray-800 dark:text-gray-100"><span id="body-fat-percentage">0</span>%</div>
                                            <div class="text-sm text-gray-500 dark:text-gray-400">Gordura Corporal</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-6">
                                    <div class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Classificação</div>
                                    <div id="fat-classification" class="text-lg font-semibold">-</div>
                                </div>

                                <div class="mb-6 grid grid-cols-2 gap-4">
                                    <div class="text-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                        <div class="text-lg font-bold" id="bmi-value">0</div>
                                        <div class="text-xs text-gray-500">IMC</div>
                                    </div>
                                    <div class="text-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                        <div class="text-lg font-bold" id="density-value">0</div>
                                        <div class="text-xs text-gray-500">Densidade</div>
                                    </div>
                                </div>
                                
                                <div class="mb-6">
                                    <div class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-3">Composição Corporal</div>
                                    
                                    <div class="flex items-center mb-2">
                                        <div class="w-16 text-sm text-gray-700 dark:text-gray-300">Gordura</div>
                                        <div class="flex-1 mx-2">
                                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                                                <div id="fat-bar" class="bg-yellow-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                                            </div>
                                        </div>
                                        <div id="fat-mass" class="w-16 text-right font-medium text-gray-700 dark:text-gray-300">0 kg</div>
                                    </div>
                                    
                                    <div class="flex items-center">
                                        <div class="w-16 text-sm text-gray-700 dark:text-gray-300">Massa Magra</div>
                                        <div class="flex-1 mx-2">
                                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                                                <div id="lean-bar" class="bg-blue-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                                            </div>
                                        </div>
                                        <div id="lean-mass" class="w-16 text-right font-medium text-gray-700 dark:text-gray-300">0 kg</div>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 gap-3 mt-6">
                                    <button id="save-btn" class="bg-accent hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition btn-hover-lift">
                                        <i class="fas fa-save mr-2"></i>
                                        Salvar Avaliação
                                    </button>
                                    
                                    <button id="report-btn" class="bg-white dark:bg-gray-800 border border-accent text-accent dark:text-green-400 hover:bg-green-50 dark:hover:bg-gray-700 font-medium py-2 px-4 rounded-lg transition btn-hover-lift">
                                        <i class="fas fa-file-pdf mr-2"></i>
                                        Gerar Relatório PDF
                                    </button>

                                    <button id="reset-btn" class="bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 text-gray-700 dark:text-gray-200 font-medium py-2 px-4 rounded-lg transition">
                                        <i class="fas fa-redo mr-2"></i>
                                        Limpar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="section-clients" class="app-section p-4 md:p-6 animate-fadeIn">
                <div class="card-blur p-6 rounded-lg shadow-md">
                    <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold mb-4 md:mb-0 text-gray-900">Lista de Clientes</h2>
                        <button id="add-client-btn" class="bg-accent hover:bg-green-700 text-white py-2 px-4 rounded-lg flex items-center btn-hover-lift">
                            <i class="fas fa-plus mr-2"></i>
                            Adicionar Cliente
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-800">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        Cliente
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        Contato
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        Status
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        Última Avaliação
                                    </th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        Ações
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="clients-table-body" class="bg-white dark:bg-gray-700 divide-y divide-gray-200 dark:divide-gray-600">
                                <tr>
                                    <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                                        Carregando clientes...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="section-evaluations" class="app-section p-4 md:p-6 animate-fadeIn">
                <div class="card-blur p-6 rounded-lg shadow-md">
                    <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold mb-4 md:mb-0 text-gray-900">Avaliações Realizadas</h2>
                        <button onclick="document.getElementById('nav-calculator').click()" class="bg-accent hover:bg-green-700 text-white py-2 px-4 rounded-lg flex items-center btn-hover-lift">
                            <i class="fas fa-plus mr-2"></i>
                            Nova Avaliação
                        </button>
                    </div>
                    
                    <div id="evaluations-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="text-center py-8 text-gray-500 col-span-full">
                            Carregando avaliações...
                        </div>
                    </div>
                </div>
            </section>

            <section id="section-workouts" class="app-section p-4 md:p-6 animate-fadeIn">
                <div class="max-w-7xl mx-auto">
                    <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-6">
                        <div>
                            <h2 class="text-2xl font-bold mb-1 text-gray-900">Treinos</h2>

                        </div>
                        <button id="create-workout-btn" class="bg-accent hover:bg-green-700 text-white py-2 px-4 rounded-lg flex items-center btn-hover-lift">
                            <i class="fas fa-plus mr-2"></i>
                            Criar Treino
                        </button>
                    </div>

                    <div class="mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="workout-template card-blur p-4 rounded-lg shadow-md cursor-pointer" data-type="Força">
                                <div class="flex items-center mb-2">
                                    <i class="fas fa-dumbbell text-2xl text-red-600 mr-3"></i>
                                    <h4 class="font-medium">Treino de Força</h4>
                                </div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Exercícios com peso focados em ganho de massa</p>
                            </div>
                            <div class="workout-template card-blur p-4 rounded-lg shadow-md cursor-pointer" data-type="Cardio">
                                <div class="flex items-center mb-2">
                                    <i class="fas fa-heartbeat text-2xl text-blue-600 mr-3"></i>
                                    <h4 class="font-medium">Treino Cardio</h4>
                                </div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Exercícios cardiovasculares para resistência</p>
                            </div>
                            <div class="workout-template card-blur p-4 rounded-lg shadow-md cursor-pointer" data-type="Funcional">
                                <div class="flex items-center mb-2">
                                    <i class="fas fa-running text-2xl text-green-600 mr-3"></i>
                                    <h4 class="font-medium">Treino Funcional</h4>
                                </div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Movimentos funcionais para o dia a dia</p>
                            </div>
                        </div>
                    </div>

                    <div id="workouts-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="text-center py-8 text-gray-500 col-span-full">
                            Carregando treinos...
                        </div>
                    </div>
                </div>
            </section>

            <section id="section-schedule" class="app-section p-4 md:p-6 animate-fadeIn">
                <div class="max-w-7xl mx-auto">
                    <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-6">
                        <div>
                            <h2 class="text-2xl font-bold mb-2 text-gray-900">Agenda</h2>
                        </div>
                        <button id="add-appointment-btn" class="bg-accent hover:bg-green-700 text-white py-2 px-4 rounded-lg flex items-center btn-hover-lift">
                            <i class="fas fa-plus mr-2"></i>
                            Novo Agendamento
                        </button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2">
                            <div class="card-blur p-6 rounded-lg shadow-md">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="font-semibold text-lg" id="calendar-month-year">Dezembro 2024</h3>
                                    <div class="flex space-x-2">
                                        <button id="prev-month" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                                            <i class="fas fa-chevron-left"></i>
                                        </button>
                                        <button id="today-btn" class="px-3 py-1 text-sm bg-accent text-white rounded-lg">Hoje</button>
                                        <button id="next-month" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="calendar-grid mb-2">
                                    <div class="text-center text-sm font-medium text-gray-500 dark:text-gray-400 p-2">Dom</div>
                                    <div class="text-center text-sm font-medium text-gray-500 dark:text-gray-400 p-2">Seg</div>
                                    <div class="text-center text-sm font-medium text-gray-500 dark:text-gray-400 p-2">Ter</div>
                                    <div class="text-center text-sm font-medium text-gray-500 dark:text-gray-400 p-2">Qua</div>
                                    <div class="text-center text-sm font-medium text-gray-500 dark:text-gray-400 p-2">Qui</div>
                                    <div class="text-center text-sm font-medium text-gray-500 dark:text-gray-400 p-2">Sex</div>
                                    <div class="text-center text-sm font-medium text-gray-500 dark:text-gray-400 p-2">Sáb</div>
                                </div>

                                <div class="calendar-grid" id="calendar-days">
                                </div>
                            </div>
                        </div>

                        <div class="card-blur p-6 rounded-lg shadow-md">
                            <h3 class="font-semibold mb-4">Próximos Agendamentos</h3>
                            <div id="upcoming-appointments-list" class="space-y-3">
                                <div class="text-center text-gray-500">
                                    Carregando agendamentos...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="section-settings" class="app-section p-4 md:p-6 animate-fadeIn">
                <div class="max-w-4xl mx-auto">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold mb-2 text-gray-900">Configurações</h2>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 card-blur p-6 rounded-lg shadow-md">
                            <h3 class="font-semibold mb-4 text-gray-900">Perfil Profissional</h3>
                            
                            <div class="flex justify-center mb-6">
                                <div class="profile-image-upload" onclick="document.getElementById('profile-image-input').click()">
                                    <img id="profile-image-preview" src="images/logo.jpg" alt="Foto de perfil" class="w-24 h-24 rounded-full object-cover border-4 border-white shadow-lg">
                                    <input type="file" id="profile-image-input" accept="image/*" style="display: none;">
                                    <div class="upload-overlay">
                                        <i class="fas fa-camera text-white text-xl"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <form id="profile-form" class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Nome Completo</label>
                                        <input type="text" id="profile-name" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100" placeholder="Seu nome completo">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Email</label>
                                        <input type="email" id="profile-email" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100" placeholder="seu@email.com" readonly>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Telefone</label>
                                        <input type="tel" id="profile-phone" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100" placeholder="(11) 99999-9999">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">CREF</label>
                                        <input type="text" id="profile-cref" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100" placeholder="123456-G/SP">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Especialidades</label>
                                    <textarea id="profile-specialties" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100" rows="3" placeholder="Suas áreas de especialização..."></textarea>
                                </div>
                                <button type="submit" class="bg-accent hover:bg-green-700 text-white py-2 px-4 rounded-lg btn-hover-lift">
                                    <i class="fas fa-save mr-2"></i>
                                    Salvar Perfil
                                </button>
                            </form>
                        </div>

                        <div class="card-blur p-6 rounded-lg shadow-md">
                            <h3 class="font-semibold mb-4 text-gray-900">Preferências</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Tema</label>
                                    <select id="theme-select" class="w-full p-2.5 border border-gray-300 dark:border-gray-600 rounded-lg text-base bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                        <option value="auto">Automático</option>
                                        <option value="light" selected>Claro</option>
                                        <option value="dark">Escuro</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Protocolo Padrão</label>
                                    <select id="default-protocol" class="w-full p-2.5 border border-gray-300 dark:border-gray-600 rounded-lg text-base bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                        <option value="jp3" selected>Jackson-Pollock 3</option>
                                        <option value="jp7">Jackson-Pollock 7</option>
                                        <option value="faulkner">Faulkner</option>
                                        <option value="durnin">Durnin & Womersley</option>
                                        <option value="petroski">Petroski</option>
                                        <option value="guedes">Guedes</option>
                                    </select>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium">Backup Automático</span>
                                    <input type="checkbox" id="auto-backup" class="w-4 h-4" checked>
                                </div>
                            </div>

                            <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                                <h4 class="font-medium mb-3">Dados</h4>
                                <div class="space-y-2">
                                    <button id="export-data-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded-lg text-sm btn-hover-lift">
                                        <i class="fas fa-download mr-2"></i>
                                        Exportar Dados
                                    </button>
                                    <button id="backup-cloud-btn" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-3 rounded-lg text-sm btn-hover-lift">
                                        <i class="fas fa-cloud-upload-alt mr-2"></i>
                                        Backup na Nuvem
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Client Detail Modal -->
    <div id="client-detail-modal" class="modal">
        <div class="modal-content p-0 rounded-lg max-w-5xl w-full mx-4">
            <div class="sticky top-0 bg-white dark:bg-gray-800 p-6 border-b border-gray-200 dark:border-gray-700 rounded-t-lg flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button id="back-to-clients" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div>
                        <h2 class="text-xl font-bold" id="client-detail-title">Cliente</h2>
                        <p class="text-sm text-gray-600 dark:text-gray-400" id="client-detail-subtitle"></p>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button id="client-detail-new-eval-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg flex items-center text-sm">
                        <i class="fas fa-plus mr-2"></i>
                        Nova Avaliação
                    </button>
                    <button id="client-detail-new-workout-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center text-sm">
                        <i class="fas fa-dumbbell mr-2"></i>
                        Novo Treino
                    </button>
                    <button id="client-detail-edit-btn" class="bg-gray-600 text-white px-4 py-2 rounded-lg flex items-center text-sm">
                        <i class="fas fa-edit mr-2"></i>
                        Editar
                    </button>
                </div>
            </div>

            <div class="border-b border-gray-200 dark:border-gray-700">
                <nav class="flex space-x-8 px-6">
                    <button class="client-detail-tab-btn py-3 px-1 text-sm font-medium border-b-2 border-green-600 text-green-600" data-tab="overview">
                        Visão Geral
                    </button>
                    <button class="client-detail-tab-btn py-3 px-1 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="photos">
                        Fotos
                    </button>
                    <button class="client-detail-tab-btn py-3 px-1 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="evaluations">
                        Avaliações
                    </button>
                    <button class="client-detail-tab-btn py-3 px-1 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="workouts">
                        Treinos
                    </button>
                    <button class="client-detail-tab-btn py-3 px-1 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="evolution">
                        Evolução das Avaliações
                    </button>
                    <button class="client-detail-tab-btn py-3 px-1 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="reports">
                        Relatórios
                    </button>
                </nav>
            </div>

            <div class="p-6">
                <div id="client-tab-overview" class="client-tab active">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
                            <h3 class="font-semibold mb-3">Informações Pessoais</h3>
                            <div id="client-overview-info" class="space-y-2 text-sm">
                                <div class="text-center text-gray-500">Carregando...</div>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
                            <h3 class="font-semibold mb-3">Última Avaliação</h3>
                            <div id="client-overview-eval" class="text-center">
                                <div class="text-gray-500">Carregando...</div>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
                            <h3 class="font-semibold mb-3">Treinos Ativos</h3>
                            <div id="client-overview-workouts" class="text-center">
                                <div class="text-gray-500">Carregando...</div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 bg-white dark:bg-gray-700 p-6 rounded-lg shadow">
                        <h3 class="font-semibold mb-4">Evolução das Avaliações</h3>
                        <div class="chart-container">
                            <canvas id="clientEvolutionChart"></canvas>
                        </div>
                    </div>
                </div>

                <div id="client-tab-photos" class="client-tab">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="card-blur p-4 rounded-lg">
                            <h4 class="font-semibold mb-3 text-center">Fotos - Antes</h4>
                            <div class="image-gallery" id="client-photos-before">
                                <div class="add-image-btn" onclick="handleAddImageClick('before')">
                                    <i class="fas fa-plus text-2xl text-gray-400 mb-2"></i>
                                    <span class="text-sm text-gray-500">Adicionar Fotos</span>
                                </div>
                            </div>
                            <input type="file" id="client-photo-before-input" class="hidden" accept="image/*" multiple>
                        </div>
                        <div class="card-blur p-4 rounded-lg">
                            <h4 class="font-semibold mb-3 text-center">Fotos - Depois</h4>
                            <div class="image-gallery" id="client-photos-after">
                                <div class="add-image-btn" onclick="handleAddImageClick('after')">
                                    <i class="fas fa-plus text-2xl text-gray-400 mb-2"></i>
                                    <span class="text-sm text-gray-500">Adicionar Fotos</span>
                                </div>
                            </div>
                            <input type="file" id="client-photo-after-input" class="hidden" accept="image/*" multiple>
                        </div>
                    </div>
                </div>

                <div id="client-tab-evaluations" class="client-tab">
                    <div id="client-evaluations-list" class="space-y-4">
                        <div class="text-center text-gray-500">Carregando avaliações...</div>
                    </div>
                </div>

                <div id="client-tab-workouts" class="client-tab">
                    <div id="client-workouts-list">
                        <div class="text-center text-gray-500">Carregando treinos...</div>
                    </div>
                </div>
                <div id="client-tab-evolution" class="client-tab">
                    <div class="max-w-7xl mx-auto">
                        <div class="mb-6">
                            <h3 class="text-lg font-bold mb-2">Evolução das Avaliações</h3>
                            <p class="text-gray-600 dark:text-gray-300">Gerencie e compare as avaliações do cliente</p>
                        </div>
                
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                            <div class="card-blur p-4 rounded-lg shadow-md">
                                <h4 class="font-semibold mb-3">Ações Rápidas</h4>
                                <div class="space-y-2">
                                    <button id="select-evaluations-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg btn-hover-lift">
                                        <i class="fas fa-check-square mr-2"></i>
                                        Selecionar Avaliações
                                    </button>
                                    <button id="edit-evaluation-btn" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg btn-hover-lift" disabled>
                                        <i class="fas fa-edit mr-2"></i>
                                        Editar Selecionada
                                    </button>
                                    <button id="remove-evaluation-btn" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg btn-hover-lift" disabled>
                                        <i class="fas fa-trash mr-2"></i>
                                        Remover Selecionada
                                    </button>
                                    <button id="compare-evaluations-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-lg btn-hover-lift" disabled>
                                        <i class="fas fa-exchange-alt mr-2"></i>
                                        Comparar Avaliações
                                    </button>
                                </div>
                            </div>
                
                            <div class="lg:col-span-2 card-blur p-4 rounded-lg shadow-md">
                                <h4 class="font-semibold mb-3">Lista de Avaliações</h4>
                                <div id="client-evaluations-selection-list" class="space-y-2 max-h-60 overflow-y-auto">
                                    <!-- Avaliações serão carregadas aqui -->
                                </div>
                            </div>
                        </div>
                
                        <div class="card-blur p-6 rounded-lg shadow-md">
                            <h4 class="font-semibold mb-4">Gráfico de Evolução</h4>
                            <div class="chart-container">
                                <canvas id="clientEvolutionDetailChart"></canvas>
                            </div>
                        </div>
                
                        <!-- Modal de Comparação -->
                        <div id="comparison-modal" class="modal">
                            <div class="modal-content p-6 rounded-lg max-w-4xl w-full mx-4">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-semibold">Comparação de Avaliações</h3>
                                    <button id="close-comparison-modal" class="text-gray-500 hover:text-gray-700">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div id="comparison-content" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <!-- Conteúdo da comparação será inserido aqui -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="client-tab-reports" class="client-tab">
                    <div class="max-w-7xl mx-auto">
                        <div class="mb-6">
                            <h3 class="text-lg font-bold mb-2">Relatórios e Análises do Cliente</h3>
                            <p class="text-gray-600 dark:text-gray-300">Visualize dados e gere relatórios personalizados para este cliente</p>
                        </div>

                        <div class="card-blur p-6 rounded-lg shadow-md mb-6">
                            <h4 class="font-semibold mb-4">Filtros de Relatório</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">Data Inicial</label>
                                    <input type="date" id="client-report-start-date" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5 text-base">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Data Final</label>
                                    <input type="date" id="client-report-end-date" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5 text-base">
                                </div>
                                <div class="flex items-end">
                                    <button id="generate-client-report-btn-filter" class="w-full bg-accent hover:bg-green-700 text-white py-2.5 px-4 rounded-lg btn-hover-lift">
                                        <i class="fas fa-chart-line mr-2"></i>
                                        Gerar Relatório
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="card-blur p-6 rounded-lg shadow-md">
                                <h4 class="font-semibold mb-4">Evolução Temporal</h4>
                                <div class="chart-container">
                                    <canvas id="clientReportsEvolutionChart"></canvas>
                                </div>
                            </div>

                            <div class="card-blur p-6 rounded-lg shadow-md">
                                <h4 class="font-semibold mb-4">Estatísticas do Cliente</h4>
                                <div id="client-report-statistics" class="space-y-4">
                                    <div class="text-center text-gray-500">
                                        Gere um relatório para ver as estatísticas
                                    </div>
                                </div>
                            </div>

                            <div class="card-blur p-6 rounded-lg shadow-md">
                                <h4 class="font-semibold mb-4">Relatório Completo</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Documento com histórico completo do cliente</p>
                                <button id="generate-client-report-btn" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg btn-hover-lift">
                                    <i class="fas fa-file-pdf mr-2"></i>
                                    Gerar PDF Completo
                                </button>
                            </div>

                            <div class="card-blur p-6 rounded-lg shadow-md">
                                <h4 class="font-semibold mb-4">Dados para Planilha</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Exportar dados em formato Excel</p>
                                <button id="export-client-data-btn" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg btn-hover-lift">
                                    <i class="fas fa-file-excel mr-2"></i>
                                    Exportar Excel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Client Modal -->
    <div id="client-modal" class="modal">
        <div class="modal-content p-6 rounded-lg max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 id="client-modal-title" class="text-lg font-semibold">Adicionar Cliente</h3>
                <button id="close-client-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="client-form">
                <input type="hidden" id="client-id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Nome Completo *</label>
                        <input type="text" id="client-name" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Email</label>
                        <input type="email" id="client-email" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Telefone</label>
                        <input type="tel" id="client-phone" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Sexo *</label>
                            <select id="client-gender" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100" required>
                                <option value="">Selecione</option>
                                <option value="Masculino">Masculino</option>
                                <option value="Feminino">Feminino</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Data de Nascimento</label>
                            <input type="date" id="client-birth-date" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Observações</label>
                        <textarea id="client-notes" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100" rows="3"></textarea>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancel-client-btn" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg">Cancelar</button>
                    <button type="submit" id="save-client-btn" class="px-4 py-2 bg-accent text-white rounded-lg btn-hover-lift">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Workout Modal -->
    <div id="workout-modal" class="modal">
        <div class="modal-content p-6 rounded-lg max-w-4xl w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 id="workout-modal-title" class="text-lg font-semibold">Criar Treino</h3>
                <button id="close-workout-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="workout-form">
                <input type="hidden" id="workout-id">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2">
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">Nome do Treino *</label>
                                    <input type="text" id="workout-name" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100" placeholder="Ex: Treino A - Peitoral e Tríceps" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Cliente *</label>
                                    <select id="workout-client" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100" required>
                                        <option value="">Selecione o cliente</option>
                                    </select>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">Tipo do Treino</label>
                                    <select id="workout-type" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                        <option value="Força">Força</option>
                                        <option value="Cardio">Cardio</option>
                                        <option value="Funcional">Funcional</option>
                                        <option value="HIIT">HIIT</option>
                                        <option value="Flexibilidade">Flexibilidade</option>
                                        <option value="Misto">Misto</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Duração (minutos)</label>
                                    <input type="number" id="workout-duration" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100" value="60" min="15" max="180">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Descrição</label>
                                <textarea id="workout-description" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100" rows="3" placeholder="Observações sobre o treino..."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Exercícios Selecionados</label>
                                <div id="workout-exercises" class="space-y-2 min-h-[100px] border border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4">
                                    <div class="text-center text-gray-500">Nenhum exercício selecionado</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold mb-3">Banco de Exercícios</h4>
                        <div class="exercise-database bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <div id="exercise-categories">
                                <!-- Exercise categories will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancel-workout-btn" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg">Cancelar</button>
                    <button type="submit" id="save-workout-btn" class="px-4 py-2 bg-accent text-white rounded-lg btn-hover-lift">Salvar Treino</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Appointment Modal -->
    <div id="appointment-modal" class="modal">
        <div class="modal-content p-6 rounded-lg max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 id="appointment-modal-title" class="text-lg font-semibold">Novo Agendamento</h3>
                <button id="close-appointment-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="appointment-form">
                <input type="hidden" id="appointment-id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Cliente *</label>
                        <select id="appointment-client" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100" required>
                            <option value="">Selecione o cliente</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Data *</label>
                            <input type="date" id="appointment-date" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Horário *</label>
                            <input type="time" id="appointment-time" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100" required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Tipo *</label>
                        <select id="appointment-type" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100" required>
                            <option value="">Selecione o tipo</option>
                            <option value="Avaliação">Avaliação Física</option>
                            <option value="Treino">Sessão de Treino</option>
                            <option value="Consulta">Consulta</option>
                            <option value="Reavaliação">Reavaliação</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Observações</label>
                        <textarea id="appointment-notes" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100" rows="3" placeholder="Observações sobre o agendamento..."></textarea>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancel-appointment-btn" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg">Cancelar</button>
                    <button type="submit" id="save-appointment-btn" class="px-4 py-2 bg-accent text-white rounded-lg btn-hover-lift">Salvar Agendamento</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const { createClient } = supabase;
        const supabaseUrl = 'https://ngishqxtnkgvognszyep.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5naXNocXh0bmtndm9nbnN6eWVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1OTMwNjcsImV4cCI6MjA2ODE2OTA2N30.FOksPjvS2NyO6dcZ_j0Grj3Prn9OP_udSGQwswtFBXE';
        const supabaseClient = createClient(supabaseUrl, supabaseKey);

        // Global variables
        let currentUser = null;
        let currentPersonalTrainer = null;
        let currentProtocol = 'jp3';
        let currentCalculationResult = null;
        let currentClientId = null;
        let calendarDate = new Date();
        let clients = [];
        let evaluations = [];
        let workouts = [];
        let appointments = [];
        let selectedExercises = [];
        let recentActivities = []; // INICIALIZAÇÃO CORRETA DA VARIÁVEL

        // Protocol configurations
        const protocolConfigs = {
            jp3: {
                male: [
                    { id: 'chest', label: 'Peitoral', unit: 'mm' },
                    { id: 'abdomen', label: 'Abdômen', unit: 'mm' },
                    { id: 'thigh', label: 'Coxa', unit: 'mm' }
                ],
                female: [
                    { id: 'triceps', label: 'Tríceps', unit: 'mm' },
                    { id: 'suprailiac', label: 'Suprailíaca', unit: 'mm' },
                    { id: 'thigh', label: 'Coxa', unit: 'mm' }
                ]
            },
            jp7: {
                both: [
                    { id: 'chest', label: 'Peitoral', unit: 'mm' },
                    { id: 'axillary', label: 'Axilar Média', unit: 'mm' },
                    { id: 'triceps', label: 'Tríceps', unit: 'mm' },
                    { id: 'subscapular', label: 'Subescapular', unit: 'mm' },
                    { id: 'abdomen', label: 'Abdômen', unit: 'mm' },
                    { id: 'suprailiac', label: 'Suprailíaca', unit: 'mm' },
                    { id: 'thigh', label: 'Coxa', unit: 'mm' }
                ]
            },
            faulkner: {
                both: [
                    { id: 'triceps', label: 'Tríceps', unit: 'mm' },
                    { id: 'subscapular', label: 'Subescapular', unit: 'mm' },
                    { id: 'suprailiac', label: 'Suprailíaca', unit: 'mm' },
                    { id: 'abdomen', label: 'Abdômen', unit: 'mm' }
                ]
            },
            durnin: {
                both: [
                    { id: 'biceps', label: 'Bíceps', unit: 'mm' },
                    { id: 'triceps', label: 'Tríceps', unit: 'mm' },
                    { id: 'subscapular', label: 'Subescapular', unit: 'mm' },
                    { id: 'suprailiac', label: 'Suprailíaca', unit: 'mm' }
                ]
            },
            petroski: {
                male: [
                    { id: 'chest', label: 'Peitoral', unit: 'mm' },
                    { id: 'abdomen', label: 'Abdômen', unit: 'mm' },
                    { id: 'thigh', label: 'Coxa', unit: 'mm' }
                ],
                female: [
                    { id: 'triceps', label: 'Tríceps', unit: 'mm' },
                    { id: 'suprailiac', label: 'Suprailíaca', unit: 'mm' },
                    { id: 'thigh', label: 'Coxa', unit: 'mm' }
                ]
            },
            guedes: {
                both: [
                    { id: 'triceps', label: 'Tríceps', unit: 'mm' },
                    { id: 'subscapular', label: 'Subescapular', unit: 'mm' }
                ]
            }
        };

        // Exercise Database
        const exerciseDatabase = {
            'Peitoral': [
                { name: 'Supino Reto', equipment: 'Barra', muscle: 'Peitoral' },
                { name: 'Supino Inclinado', equipment: 'Barra', muscle: 'Peitoral' },
                { name: 'Crucifixo', equipment: 'Halteres', muscle: 'Peitoral' },
                { name: 'Flexão de Braço', equipment: 'Peso Corporal', muscle: 'Peitoral' },
                { name: 'Peck Deck', equipment: 'Máquina', muscle: 'Peitoral' }
            ],
            'Costas': [
                { name: 'Puxada Alta', equipment: 'Máquina', muscle: 'Latíssimo' },
                { name: 'Remada Curvada', equipment: 'Barra', muscle: 'Romboides' },
                { name: 'Remada Sentada', equipment: 'Cabo', muscle: 'Latíssimo' },
                { name: 'Barra Fixa', equipment: 'Peso Corporal', muscle: 'Latíssimo' },
                { name: 'Pullover', equipment: 'Halter', muscle: 'Latíssimo' }
            ],
            'Ombros': [
                { name: 'Desenvolvimento', equipment: 'Halteres', muscle: 'Deltóide' },
                { name: 'Elevação Lateral', equipment: 'Halteres', muscle: 'Deltóide Médio' },
                { name: 'Elevação Frontal', equipment: 'Halteres', muscle: 'Deltóide Anterior' },
                { name: 'Crucifixo Inverso', equipment: 'Halteres', muscle: 'Deltóide Posterior' },
                { name: 'Encolhimento', equipment: 'Halteres', muscle: 'Trapézio' }
            ],
            'Braços': [
                { name: 'Rosca Direta', equipment: 'Barra', muscle: 'Bíceps' },
                { name: 'Rosca Alternada', equipment: 'Halteres', muscle: 'Bíceps' },
                { name: 'Tríceps Testa', equipment: 'Barra', muscle: 'Tríceps' },
                { name: 'Tríceps Corda', equipment: 'Cabo', muscle: 'Tríceps' },
                { name: 'Rosca Martelo', equipment: 'Halteres', muscle: 'Bíceps' }
            ],
            'Pernas': [
                { name: 'Agachamento', equipment: 'Barra', muscle: 'Quadríceps' },
                { name: 'Leg Press', equipment: 'Máquina', muscle: 'Quadríceps' },
                { name: 'Extensora', equipment: 'Máquina', muscle: 'Quadríceps' },
                { name: 'Flexora', equipment: 'Máquina', muscle: 'Posterior' },
                { name: 'Panturrilha', equipment: 'Máquina', muscle: 'Panturrilha' }
            ],
            'Abdômen': [
                { name: 'Abdominal Supra', equipment: 'Peso Corporal', muscle: 'Reto Abdominal' },
                { name: 'Prancha', equipment: 'Peso Corporal', muscle: 'Core' },
                { name: 'Abdominal Oblíquo', equipment: 'Peso Corporal', muscle: 'Oblíquos' },
                { name: 'Elevação de Pernas', equipment: 'Peso Corporal', muscle: 'Reto Abdominal' },
                { name: 'Russian Twist', equipment: 'Peso Corporal', muscle: 'Oblíquos' }
            ],
            'Cardio': [
                { name: 'Esteira', equipment: 'Máquina', muscle: 'Cardiovascular' },
                { name: 'Bicicleta', equipment: 'Máquina', muscle: 'Cardiovascular' },
                { name: 'Elíptico', equipment: 'Máquina', muscle: 'Cardiovascular' },
                { name: 'Remo', equipment: 'Máquina', muscle: 'Cardiovascular' },
                { name: 'Transport', equipment: 'Peso Corporal', muscle: 'Cardiovascular' }
            ]
        };

        // UTILITY FUNCTIONS FOR DATE HANDLING
function formatDateForInput(date) {
    if (!date) return '';
    if (typeof date === 'string') {
        // Se já é uma string de data, retornar como está
        return date.slice(0, 10);
    }
    const d = new Date(date);
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

function formatDateForStorage(dateString) {
    if (!dateString) return null;
    // Garantir que a data seja armazenada no formato YYYY-MM-DD
    return dateString;
}

function createDateFromString(dateString) {
    if (!dateString) return new Date();
    // Criar data sem considerar timezone
    const [year, month, day] = dateString.split('-').map(Number);
    return new Date(year, month - 1, day);
}

        // --- UTILITY FUNCTIONS ---
        function showNotification(message, type = 'success') {
            // Remove existing notifications
            document.querySelectorAll('.notification').forEach(notification => {
                notification.remove();
            });
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        function showLoading() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) overlay.classList.add('show');
        }

        function hideLoading() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) overlay.classList.remove('show');
        }

        function showConfirmDialog(message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999]';
            modal.style.zIndex = '9999';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4 relative z-[10000]">
                    <div class="flex items-center mb-4">
                        <div class="bg-red-100 rounded-full p-2 mr-3">
                            <i class="fas fa-exclamation-triangle text-red-600"></i>
                        </div>
                        <h3 class="text-lg font-semibold">Confirmar Ação</h3>
                    </div>
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end space-x-3">
                        <button class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition">Cancelar</button>
                        <button class="confirm-btn px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded transition">Confirmar</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.querySelector('.cancel-btn').onclick = () => modal.remove();
            modal.querySelector('.confirm-btn').onclick = () => {
                modal.remove();
                onConfirm();
            };
            
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            
            document.body.style.overflow = 'hidden';
            
            const originalRemove = modal.remove;
            modal.remove = function() {
                document.body.style.overflow = '';
                originalRemove.call(this);
            };
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('login-error');
            const messageSpan = document.getElementById('login-error-message');
            if (errorDiv && messageSpan) {
                messageSpan.textContent = message;
                errorDiv.classList.remove('hidden');
                
                setTimeout(() => {
                    errorDiv.classList.add('hidden');
                }, 5000);
            }
        }

        // FUNÇÃO PARA CONVERSÃO DE ARQUIVO PARA BASE64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // FUNÇÃO PARA LIDAR COM UPLOAD DE IMAGENS
        async function handleImageUpload(file, type = 'profile') {
            try {
                if (file.size > 5 * 1024 * 1024) {
                    throw new Error('Arquivo muito grande. Máximo 5MB.');
                }

                if (!file.type.startsWith('image/')) {
                    throw new Error('Apenas arquivos de imagem são permitidos.');
                }

                const base64 = await fileToBase64(file);
                return base64;
            } catch (error) {
                console.error('Error uploading image:', error);
                showNotification('Erro ao fazer upload da imagem: ' + error.message, 'error');
                return null;
            }
        }

        // FUNÇÃO PARA GERAÇÃO DE RELATÓRIOS EM PDF
        function generatePDFReport(clientData, evaluationData) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.setFontSize(20);
                doc.text('Shape Fit - Relatório de Avaliação', 20, 30);
                
                doc.setFontSize(12);
                doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 20, 45);
                doc.text(`Personal Trainer: ${currentPersonalTrainer?.name || 'N/A'}`, 20, 55);
                
                doc.setFontSize(16);
                doc.text('Dados do Cliente', 20, 75);
                doc.setFontSize(12);
                doc.text(`Nome: ${clientData.name}`, 20, 90);
                doc.text(`Email: ${clientData.email || 'Não informado'}`, 20, 100);
                doc.text(`Telefone: ${clientData.phone || 'Não informado'}`, 20, 110);
                doc.text(`Sexo: ${clientData.gender || 'Não informado'}`, 20, 120);

                doc.setFontSize(16);
                doc.text('Resultados da Avaliação', 20, 140);
                doc.setFontSize(12);
                doc.text(`Protocolo: ${evaluationData.protocol}`, 20, 155);
                doc.text(`Percentual de Gordura: ${evaluationData.bodyFat}%`, 20, 165);
                doc.text(`IMC: ${evaluationData.bmi}`, 20, 175);
                doc.text(`Peso: ${evaluationData.weight} kg`, 20, 185);
                doc.text(`Altura: ${evaluationData.height} m`, 20, 195);
                doc.text(`Massa Gorda: ${evaluationData.fatMass} kg`, 20, 205);
                doc.text(`Massa Magra: ${evaluationData.leanMass} kg`, 20, 215);

                if (evaluationData.measurements) {
                    doc.setFontSize(16);
                    doc.text('Medidas (mm)', 20, 235);
                    doc.setFontSize(12);
                    let yPos = 250;
                    Object.entries(evaluationData.measurements).forEach(([key, value]) => {
                        doc.text(`${key}: ${value} mm`, 20, yPos);
                        yPos += 10;
                    });
                }

                doc.save(`relatorio-${clientData.name.replace(/\s+/g, '-')}-${new Date().toISOString().slice(0,10)}.pdf`);
                showNotification('Relatório PDF gerado com sucesso!', 'success');
            } catch (error) {
                console.error('Error generating PDF:', error);
                showNotification('Erro ao gerar relatório PDF: ' + error.message, 'error');
            }
        }

        // FUNÇÃO PARA EXPORTAR DADOS EM EXCEL
        function exportToExcel(data, filename) {
            try {
                const worksheet = XLSX.utils.json_to_sheet(data);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Dados");
                XLSX.writeFile(workbook, `${filename}-${new Date().toISOString().slice(0,10)}.xlsx`);
                showNotification('Dados exportados com sucesso!', 'success');
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                showNotification('Erro ao exportar dados: ' + error.message, 'error');
            }
        }

        // --- THEME MANAGEMENT ---
        function initializeTheme() {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
                document.body.classList.remove('light');
                document.body.classList.add('dark');
                const icon = document.querySelector('#theme-toggle i');
                if (icon) {
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                }
            }

            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (event.matches) {
                    document.documentElement.classList.add('dark');
                    document.body.classList.remove('light');
                    document.body.classList.add('dark');
                    const icon = document.querySelector('#theme-toggle i');
                    if (icon) {
                        icon.classList.remove('fa-moon');
                        icon.classList.add('fa-sun');
                    }
                } else {
                    document.documentElement.classList.remove('dark');
                    document.body.classList.remove('dark');
                    document.body.classList.add('light');
                    const icon = document.querySelector('#theme-toggle i');
                    if (icon) {
                        icon.classList.remove('fa-sun');
                        icon.classList.add('fa-moon');
                    }
                }
            });
        }

        // --- SUPABASE FUNCTIONS ---
        async function getPersonalTrainerByEmail(email) {
            try {
                const { data, error } = await supabaseClient
                    .from('shapefit_personal_trainers')
                    .select('*')
                    .eq('email', email)
                    .single();

                if (error && error.code !== 'PGRST116') throw error;
                return data;
            } catch (error) {
                console.error('Error getting personal trainer:', error);
                return null;
            }
        }

        async function createPersonalTrainer(email, name) {
            try {
                const { data, error } = await supabaseClient
                    .from('shapefit_personal_trainers')
                    .insert([{
                        email: email,
                        name: name || email.split('@')[0],
                        created_at: new Date().toISOString()
                    }])
                    .select()
                    .single();

                if (error) throw error;
                return data;
            } catch (error) {
                console.error('Error creating personal trainer:', error);
                throw error;
            }
        }

        async function loadUserData() {
            if (!currentPersonalTrainer) return;

            try {
                showLoading();

                // Load clients with better error handling
                const { data: clientsData, error: clientsError } = await supabaseClient
                    .from('shapefit_clients')
                    .select('*')
                    .eq('personal_trainer_id', currentPersonalTrainer.id)
                    .order('created_at', { ascending: false });

                if (clientsError) throw clientsError;
                clients = clientsData || [];

                // Load client photos
                for (let client of clients) {
                    const { data: photosData, error: photosError } = await supabaseClient
                        .from('shapefit_client_photos')
                        .select('*')
                        .eq('client_id', client.id);

                    if (!photosError && photosData) {
                        client.photos_before = photosData.filter(p => p.photo_type === 'before').map(p => p.photo_url);
                        client.photos_after = photosData.filter(p => p.photo_type === 'after').map(p => p.photo_url);
                    } else {
                        client.photos_before = [];
                        client.photos_after = [];
                    }
                }

                // Load evaluations
                const { data: evaluationsData, error: evaluationsError } = await supabaseClient
                    .from('shapefit_evaluations')
                    .select('*')
                    .eq('personal_trainer_id', currentPersonalTrainer.id)
                    .order('created_at', { ascending: false });

                if (evaluationsError) throw evaluationsError;
                evaluations = evaluationsData || [];

                // Load workouts
                const { data: workoutsData, error: workoutsError } = await supabaseClient
                    .from('shapefit_workouts')
                    .select('*')
                    .eq('personal_trainer_id', currentPersonalTrainer.id)
                    .order('created_at', { ascending: false });

                if (workoutsError) throw workoutsError;
                workouts = workoutsData || [];

                // Load appointments
                const { data: appointmentsData, error: appointmentsError } = await supabaseClient
                    .from('shapefit_appointments')
                    .select('*')
                    .eq('personal_trainer_id', currentPersonalTrainer.id)
                    .order('date', { ascending: true });

                if (appointmentsError) throw appointmentsError;
                appointments = appointmentsData || [];

                // Load profile data
                if (currentPersonalTrainer) {
                    const profileName = document.getElementById('profile-name');
                    const profileEmail = document.getElementById('profile-email');
                    const profilePhone = document.getElementById('profile-phone');
                    const profileCref = document.getElementById('profile-cref');
                    const profileSpecialties = document.getElementById('profile-specialties');
                    const userName = document.getElementById('user-name');
                    const profileImagePreview = document.getElementById('profile-image-preview');
                    const userAvatar = document.getElementById('user-avatar');

                    if (profileName) profileName.value = currentPersonalTrainer.name || '';
                    if (profileEmail) profileEmail.value = currentPersonalTrainer.email || '';
                    if (profilePhone) profilePhone.value = currentPersonalTrainer.phone || '';
                    if (profileCref) profileCref.value = currentPersonalTrainer.cref || '';
                    if (profileSpecialties) profileSpecialties.value = currentPersonalTrainer.specialties || '';
                    if (userName) userName.textContent = currentPersonalTrainer.name || 'Personal Trainer';
                    
                    if (currentPersonalTrainer.avatar_url) {
                        if (profileImagePreview) profileImagePreview.src = currentPersonalTrainer.avatar_url;
                        if (userAvatar) userAvatar.src = currentPersonalTrainer.avatar_url;
                    }
                }

                // Load recent activities
                loadRecentActivities();

                renderAll();
                updateDashboardStats();
                hideLoading();
            } catch (error) {
                console.error('Error loading user data:', error);
                showNotification('Erro ao carregar dados: ' + error.message, 'error');
                hideLoading();
            }
        }

        // === SISTEMA DE ATIVIDADES RECENTES ===
        function addRecentActivity(type, description, clientName = null, data = {}) {
            const activity = {
                id: Date.now() + Math.random(),
                type: type,
                description: description,
                clientName: clientName,
                timestamp: new Date().toISOString(),
                data: data
            };
            
            recentActivities.unshift(activity);
            
            // Manter apenas as últimas 20 atividades
            if (recentActivities.length > 20) {
                recentActivities = recentActivities.slice(0, 20);
            }
            
            renderRecentActivities();
            
            // Salvar no localStorage para persistência
            try {
                localStorage.setItem('shapefit_recent_activities', JSON.stringify(recentActivities));
            } catch (error) {
                console.warn('Could not save activities to localStorage:', error);
            }
        }

        function loadRecentActivities() {
            try {
                const saved = localStorage.getItem('shapefit_recent_activities');
                if (saved) {
                    recentActivities = JSON.parse(saved);
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    recentActivities = recentActivities.filter(activity => 
                        new Date(activity.timestamp) > thirtyDaysAgo
                    );
                }
            } catch (error) {
                console.warn('Could not load activities from localStorage:', error);
                recentActivities = [];
            }
        }

        function renderRecentActivities() {
            const container = document.getElementById('recent-activities');
            if (!container) return;
            
            if (recentActivities.length === 0) {
                container.innerHTML = `
                    <li class="text-center py-4 text-gray-500 dark:text-gray-400">
                        <div class="text-2xl mb-2"><i class="fas fa-clock"></i></div>
                        <p class="text-sm">Nenhuma atividade recente</p>
                    </li>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            recentActivities.slice(0, 10).forEach((activity, index) => {
                const timeAgo = getTimeAgo(activity.timestamp);
                const icon = getActivityIcon(activity.type);
                const color = getActivityColor(activity.type);
                
                const li = document.createElement('li');
                li.className = `activity-item border-b border-gray-100 dark:border-gray-600 pb-3 mb-3 last:border-b-0 last:pb-0 last:mb-0`;
                li.innerHTML = `
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0 w-8 h-8 ${color} rounded-full flex items-center justify-center text-white text-sm">
                            <i class="${icon}"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm text-gray-900 dark:text-gray-100">${activity.description}</p>
                            ${activity.clientName ? `<p class="text-xs text-gray-600 dark:text-gray-400 mt-1">Cliente: ${activity.clientName}</p>` : ''}
                            <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">${timeAgo}</p>
                        </div>
                    </div>
                `;
                
                container.appendChild(li);
            });
        }

        function getActivityIcon(type) {
            const icons = {
                'client_created': 'fas fa-user-plus',
                'client_updated': 'fas fa-user-edit',
                'client_deleted': 'fas fa-user-minus',
                'evaluation_created': 'fas fa-clipboard-check',
                'workout_created': 'fas fa-dumbbell',
                'workout_updated': 'fas fa-edit',
                'appointment_created': 'fas fa-calendar-plus',
                'appointment_updated': 'fas fa-calendar-check',
                'photo_uploaded': 'fas fa-camera',
                'report_generated': 'fas fa-file-pdf',
                'login': 'fas fa-sign-in-alt',
                'profile_updated': 'fas fa-user-cog'
            };
            return icons[type] || 'fas fa-info-circle';
        }

        function getActivityColor(type) {
            const colors = {
                'client_created': 'bg-green-500',
                'client_updated': 'bg-blue-500',
                'client_deleted': 'bg-red-500',
                'evaluation_created': 'bg-purple-500',
                'workout_created': 'bg-orange-500',
                'workout_updated': 'bg-yellow-500',
                'appointment_created': 'bg-indigo-500',
                'appointment_updated': 'bg-cyan-500',
                'photo_uploaded': 'bg-pink-500',
                'report_generated': 'bg-gray-500',
                'login': 'bg-teal-500',
                'profile_updated': 'bg-lime-500'
            };
            return colors[type] || 'bg-gray-400';
        }

        function getTimeAgo(timestamp) {
            const now = new Date();
            const past = new Date(timestamp);
            const diffMs = now - past;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Agora mesmo';
            if (diffMins < 60) return `${diffMins}m atrás`;
            if (diffHours < 24) return `${diffHours}h atrás`;
            if (diffDays < 7) return `${diffDays}d atrás`;
            return past.toLocaleDateString('pt-BR');
        }

        // --- RENDER FUNCTIONS ---
        function renderAll() {
            renderClients();
            renderEvaluations();
            renderWorkouts();
            renderCalendar();
            renderUpcomingAppointments();
            populateClientDropdowns();
            renderRecentActivities();
        }

        function renderClients() {
            const tbody = document.getElementById('clients-table-body');
            if (!tbody) return;
            
            if (clients.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                            <div class="text-4xl mb-2"><i class="fas fa-users"></i></div>
                            <p>Nenhum cliente cadastrado ainda</p>
                            <button onclick="document.getElementById('add-client-btn').click()" class="mt-2 text-green-600 hover:text-green-700">
                                Adicionar primeiro cliente
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = '';
            clients.forEach(client => {
                const initials = client.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                const lastEval = evaluations.find(e => e.client_id === client.id);
                const lastEvalDate = lastEval ? new Date(lastEval.created_at).toLocaleDateString('pt-BR') : 'Nenhuma';
                const lastEvalResult = lastEval ? `${lastEval.body_fat_percentage}% gordura` : 'Sem avaliação';
                
                tbody.innerHTML += `
                    <tr>
                        <td class="px-6 py-4">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-r from-green-400 to-green-600 flex items-center justify-center text-white font-medium">
                                    ${initials}
                                </div>
                                <div class="ml-3">
                                    <div class="font-medium text-gray-900 dark:text-gray-100">${client.name}</div>
                                    <div class="text-sm text-gray-500 dark:text-gray-400">${client.email || '-'}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900 dark:text-gray-100">${client.phone || '-'}</div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">${client.gender || '-'}</div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${client.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
                                ${client.status === 'active' ? 'Ativo' : 'Novo'}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900 dark:text-gray-100">${lastEvalDate}</div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">${lastEvalResult}</div>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <div class="flex justify-end space-x-2">
                                <button class="view-client-btn p-2 text-blue-600 hover:bg-blue-100 rounded" title="Ver detalhes" data-client-id="${client.id}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="edit-client-btn p-2 text-green-600 hover:bg-green-100 rounded" title="Editar" data-client-id="${client.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="delete-client-btn p-2 text-red-600 hover:bg-red-100 rounded" title="Excluir" data-client-id="${client.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            // Attach event listeners
document.querySelectorAll('.view-client-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        openClientDetailModal(btn.dataset.clientId);
        setupEvolutionTab();
        renderClientEvolutionList();
    });
});

            
            document.querySelectorAll('.edit-client-btn').forEach(btn => {
                btn.addEventListener('click', () => openClientModal(btn.dataset.clientId));
            });
            
            document.querySelectorAll('.delete-client-btn').forEach(btn => {
                btn.addEventListener('click', () => deleteClient(btn.dataset.clientId));
            });
        }

        function renderEvaluations() {
            const container = document.getElementById('evaluations-list');
            if (!container) return;
            
            if (evaluations.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500 col-span-full">
                        <div class="text-4xl mb-2"><i class="fas fa-clipboard-check"></i></div>
                        <p>Nenhuma avaliação realizada ainda</p>
                        <button onclick="document.getElementById('nav-calculator').click()" class="mt-2 text-green-600 hover:text-green-700">
                            Fazer primeira avaliação
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            evaluations.forEach((evaluation, index) => {
                const borderColors = ['border-green-500', 'border-blue-500', 'border-purple-500', 'border-yellow-500', 'border-red-500'];
                const textColors = ['text-green-600', 'text-blue-600', 'text-purple-600', 'text-yellow-600', 'text-red-600'];
                const borderColor = borderColors[index % borderColors.length];
                const textColor = textColors[index % textColors.length];
                const client = clients.find(c => c.id === evaluation.client_id);
                
                container.innerHTML += `
                    <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow border-l-4 ${borderColor}">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-semibold">${client?.name || 'Cliente'}</h3>
                            <span class="text-xs text-gray-500">${new Date(evaluation.created_at).toLocaleDateString('pt-BR')}</span>
                        </div>
                        <div class="text-sm text-gray-600 dark:text-gray-400 mb-2">${evaluation.protocol}</div>
                        <div class="flex items-center justify-between">
                            <div class="text-2xl font-bold ${textColor}">${evaluation.body_fat_percentage}%</div>
                            <div class="text-right">
                                <div class="text-sm text-gray-500">${evaluation.weight} kg</div>
                                <div class="text-xs text-gray-400">Peso</div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function renderWorkouts() {
            const container = document.getElementById('workouts-list-container');
            if (!container) return;
            
            if (workouts.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500 col-span-full">
                        <div class="text-4xl mb-2"><i class="fas fa-dumbbell"></i></div>
                        <p>Nenhum treino criado ainda</p>
                        <button onclick="document.getElementById('create-workout-btn').click()" class="mt-2 text-green-600 hover:text-green-700">
                            Criar primeiro treino
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            workouts.forEach(workout => {
                const statusColor = workout.status === 'active' ? 'green' : 'yellow';
                const statusText = workout.status === 'active' ? 'Ativo' : 'Pausado';
                const client = clients.find(c => c.id === workout.client_id);
                
                container.innerHTML += `
                    <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow border-l-4 border-${statusColor}-500">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-semibold">${workout.name}</h3>
                            <span class="px-2 py-1 text-xs bg-${statusColor}-100 text-${statusColor}-800 rounded-full">${statusText}</span>
                        </div>
                        <div class="text-sm text-gray-600 dark:text-gray-400 mb-2">${client?.name || 'Cliente'} • ${workout.type}</div>
                        <div class="flex items-center justify-between mb-3">
                            <div class="text-sm">${workout.exercises ? workout.exercises.length : 0} exercícios</div>
                            <div class="text-sm">${workout.duration || 60} min</div>
                        </div>
                        <div class="space-y-1 mb-3 max-h-20 overflow-y-auto">
                            ${workout.exercises ? workout.exercises.slice(0,3).map(ex => `
                                <div class="text-xs text-gray-500 dark:text-gray-400">
                                    ${ex.name} - ${ex.sets}x${ex.reps}${ex.weight ? ` (${ex.weight})` : ''}
                                </div>
                            `).join('') : ''}
                            ${workout.exercises && workout.exercises.length > 3 ? `<div class="text-xs text-gray-400">+${workout.exercises.length - 3} mais...</div>` : ''}
                        </div>
                        <div class="flex justify-end space-x-2">
                            <button class="view-workout-btn p-1 text-blue-600 hover:bg-blue-100 rounded text-sm" data-workout-id="${workout.id}" title="Visualizar">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="edit-workout-btn p-1 text-green-600 hover:bg-green-100 rounded text-sm" data-workout-id="${workout.id}" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-workout-btn p-1 text-red-600 hover:bg-red-100 rounded text-sm" data-workout-id="${workout.id}" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });

            // Attach event listeners
            document.querySelectorAll('.view-workout-btn').forEach(btn => {
                btn.addEventListener('click', () => viewWorkout(btn.dataset.workoutId));
            });
            
            document.querySelectorAll('.edit-workout-btn').forEach(btn => {
                btn.addEventListener('click', () => openWorkoutModal(btn.dataset.workoutId));
            });
            
            document.querySelectorAll('.delete-workout-btn').forEach(btn => {
                btn.addEventListener('click', () => deleteWorkout(btn.dataset.workoutId));
            });
        }

        function renderCalendar() {
            const calendarDays = document.getElementById('calendar-days');
            const monthYear = document.getElementById('calendar-month-year');
            
            if (!calendarDays || !monthYear) return;
            
            calendarDays.innerHTML = '';
            monthYear.textContent = calendarDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' }).replace(/^\w/, c => c.toUpperCase());
        
            const month = calendarDate.getMonth();
            const year = calendarDate.getFullYear();
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
        
            // Empty days at the beginning
            for (let i = 0; i < firstDayOfMonth; i++) {
                calendarDays.innerHTML += `<div class="calendar-day opacity-50"></div>`;
            }
        
            // Days of the month
            for (let i = 1; i <= daysInMonth; i++) {
                const dayDate = new Date(year, month, i);
                const isToday = dayDate.toDateString() === today.toDateString() ? 'today' : '';
                
                // Formato correto da data para comparação
                const dayDateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                
                const dayAppointments = appointments.filter(app => {
                    return app.date === dayDateString;
                });
                
                let appointmentsHtml = dayAppointments.slice(0, 2).map(app => {
                    const client = clients.find(c => c.id === app.client_id);
                    return `<div class="text-xs bg-blue-500 text-white rounded p-1 mt-1 truncate">${app.time} ${client?.name || 'Cliente'}</div>`;
                }).join('');
        
                if (dayAppointments.length > 2) {
                    appointmentsHtml += `<div class="text-xs text-gray-500 mt-1">+${dayAppointments.length - 2} mais</div>`;
                }
        
                calendarDays.innerHTML += `
                    <div class="calendar-day ${isToday}" data-date="${dayDateString}">
                        <div class="font-medium">${i}</div>
                        ${appointmentsHtml}
                    </div>
                `;
            }
        
            // Add click event to calendar days
            document.querySelectorAll('.calendar-day[data-date]').forEach(day => {
                day.addEventListener('click', () => {
                    openAppointmentModal(day.dataset.date);
                });
            });
        }

        function renderUpcomingAppointments() {
            const container = document.getElementById('upcoming-appointments-list');
            if (!container) return;
            
            const now = new Date();
            const today = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
            
            const upcoming = appointments
                .filter(app => {
                    return app.date >= today;
                })
                .sort((a, b) => {
                    const dateTimeA = new Date(a.date + 'T' + a.time);
                    const dateTimeB = new Date(b.date + 'T' + b.time);
                    return dateTimeA - dateTimeB;
                })
                .slice(0, 5);
            
            if (upcoming.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500">
                        <div class="text-2xl mb-2"><i class="fas fa-calendar"></i></div>
                        <p class="text-sm">Nenhum agendamento futuro</p>
                    </div>
                `;
                return;
            }
        
            container.innerHTML = '';
            upcoming.forEach(app => {
                const appDate = createDateFromString(app.date);
                const client = clients.find(c => c.id === app.client_id);
                
                container.innerHTML += `
                    <div class="flex items-center justify-between p-3 bg-white dark:bg-gray-700 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="bg-green-500 text-white rounded-lg w-12 h-12 flex flex-col items-center justify-center">
                                <span class="text-xs">${appDate.toLocaleDateString('pt-BR', { month: 'short' }).toUpperCase().replace('.','')}</span>
                                <span class="font-bold">${appDate.getDate()}</span>
                            </div>
                            <div>
                                <p class="font-medium">${client?.name || 'Cliente'}</p>
                                <p class="text-xs opacity-80">${app.time} - ${app.type}</p>
                            </div>
                        </div>
                        <div class="flex space-x-1">
                            <button class="edit-appointment-btn p-1 text-blue-600 hover:bg-blue-100 rounded text-sm" data-appointment-id="${app.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-appointment-btn p-1 text-red-600 hover:bg-red-100 rounded text-sm" data-appointment-id="${app.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
        
            // Attach event listeners
            document.querySelectorAll('.edit-appointment-btn').forEach(btn => {
                btn.addEventListener('click', () => openAppointmentModal(null, btn.dataset.appointmentId));
            });
            
            document.querySelectorAll('.delete-appointment-btn').forEach(btn => {
                btn.addEventListener('click', () => deleteAppointment(btn.dataset.appointmentId));
            });
        }

        function populateClientDropdowns() {
            const selects = document.querySelectorAll('#client, #workout-client, #appointment-client');
            selects.forEach(select => {
                if (!select) return;
                
                const currentValue = select.value;
                const firstOption = select.options[0];
                select.innerHTML = '';
                if (firstOption) select.appendChild(firstOption);
                
                clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = client.name;
                    select.appendChild(option);
                });
                
                if (currentValue) select.value = currentValue;
            });
        }

        function updateDashboardStats() {
            const totalClientsEl = document.getElementById('total-clients-stat');
            const totalEvalsEl = document.getElementById('total-evaluations-stat');
            const totalWorkoutsEl = document.getElementById('total-workouts-stat');
            const totalAppointmentsEl = document.getElementById('total-appointments-stat');
        
            if (totalClientsEl) totalClientsEl.textContent = clients.length;
            
            const thisMonth = new Date();
            const thisMonthEvals = evaluations.filter(e => {
                const evalDate = new Date(e.created_at);
                return evalDate.getMonth() === thisMonth.getMonth() && 
                       evalDate.getFullYear() === thisMonth.getFullYear();
            });
            if (totalEvalsEl) totalEvalsEl.textContent = thisMonthEvals.length;
            
            const activeWorkouts = workouts.filter(w => w.status === 'active');
            if (totalWorkoutsEl) totalWorkoutsEl.textContent = activeWorkouts.length;
            
            const today = new Date();
            const todayString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            const futureAppointments = appointments.filter(a => a.date >= todayString);
            if (totalAppointmentsEl) totalAppointmentsEl.textContent = futureAppointments.length;
        }
        // --- CALCULATOR FUNCTIONS ---
        function setupCalculator() {
            setupProtocolTabs();
            setupCalculatorForm();
            renderProtocolFields('jp3');
        }

        function setupProtocolTabs() {
            const tabs = document.querySelectorAll('.protocol-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    currentProtocol = this.dataset.protocol;
                    
                    tabs.forEach(t => {
                        t.classList.remove('text-green-600', 'border-green-600', 'active');
                        t.classList.add('text-gray-500', 'border-transparent');
                    });
                    this.classList.add('text-green-600', 'border-green-600', 'active');
                    this.classList.remove('text-gray-500', 'border-transparent');
                    
                    document.querySelectorAll('.protocol-form').forEach(form => {
                        form.classList.add('hidden');
                    });
                    const targetForm = document.getElementById(`form-${currentProtocol}`);
                    if (targetForm) targetForm.classList.remove('hidden');
                    
                    renderProtocolFields(currentProtocol);
                });
            });
        }

        function renderProtocolFields(protocol) {
            const config = protocolConfigs[protocol];
            if (!config) return;
            
            const container = document.getElementById(`${protocol}-fields`);
            if (!container) return;
            
            container.innerHTML = '';
            
            const gender = document.querySelector('input[name="gender"]:checked')?.value || 'male';
            let fields = [];
            
            if (config.both) {
                fields = config.both;
            } else if (config[gender]) {
                fields = config[gender];
            } else {
                fields = config.male;
            }
            
            fields.forEach(field => {
                const fieldDiv = document.createElement('div');
                const uniqueId = `${protocol}-${field.id}`;
                fieldDiv.innerHTML = `
                    <label for="${uniqueId}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">${field.label}</label>
                    <div class="input-field flex border border-gray-300 dark:border-gray-600 rounded-lg overflow-hidden">
                        <input type="number" id="${uniqueId}" step="0.1" class="p-2.5 flex-1 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 text-base protocol-field" 
                               data-field="${field.id}" placeholder="${field.unit}" min="0" max="100">
                        <span class="bg-gray-100 dark:bg-gray-600 text-gray-500 dark:text-gray-300 font-medium px-3 inline-flex items-center">${field.unit}</span>
                    </div>
                `;
                container.appendChild(fieldDiv);
            });
        }

        function setupCalculatorForm() {
            document.querySelectorAll('input[name="gender"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    renderProtocolFields(currentProtocol);
                });
            });
            
            const calculateBtn = document.getElementById('calculate-btn');
            const saveBtn = document.getElementById('save-btn');
            const resetBtn = document.getElementById('reset-btn');
            const reportBtn = document.getElementById('report-btn');

            if (calculateBtn) calculateBtn.addEventListener('click', calculateBodyComposition);
            if (saveBtn) saveBtn.addEventListener('click', handleSaveEvaluation);
            if (resetBtn) resetBtn.addEventListener('click', resetCalculatorForm);
            if (reportBtn) reportBtn.addEventListener('click', generateEvaluationReport);
        }

        function calculateBodyComposition() {
            const age = parseFloat(document.getElementById('age')?.value || 0);
            const weight = parseFloat(document.getElementById('weight')?.value || 0);
            const height = parseFloat(document.getElementById('height')?.value || 0);
            const gender = document.querySelector('input[name="gender"]:checked')?.value;
            
            if (!age || !weight || !height || !gender) {
                showNotification('Preencha idade, peso, altura e sexo.', 'error');
                return;
            }
            
            try {
                let bodyFat = 0;
                let measurements = {};
                let density = 0;
                
                const protocolFields = document.querySelectorAll(`#form-${currentProtocol} .protocol-field`);
                
                if (protocolFields.length === 0) {
                    throw new Error('Nenhum campo de medição encontrado');
                }
                
                protocolFields.forEach(field => {
                    const value = parseFloat(field.value) || 0;
                    const fieldName = field.dataset.field;
                    
                    if (value === 0) {
                        throw new Error(`Preencha o campo ${field.previousElementSibling.textContent}`);
                    }
                    measurements[fieldName] = value;
                });
                
                switch (currentProtocol) {
                    case 'jp3':
                        const result = calculateJP3(measurements, age, gender);
                        bodyFat = result.bodyFat;
                        density = result.density;
                        break;
                    case 'jp7':
                        const result7 = calculateJP7(measurements, age, gender);
                        bodyFat = result7.bodyFat;
                        density = result7.density;
                        break;
                    case 'faulkner':
                        bodyFat = calculateFaulkner(measurements, gender);
                        density = 1.1;
                        break;
                    case 'durnin':
                        const resultDurnin = calculateDurnin(measurements, age, gender);
                        bodyFat = resultDurnin.bodyFat;
                        density = resultDurnin.density;
                        break;
                    case 'petroski':
                        const resultPetroski = calculatePetroski(measurements, age, gender);
                        bodyFat = resultPetroski.bodyFat;
                        density = resultPetroski.density;
                        break;
                    case 'guedes':
                        bodyFat = calculateGuedes(measurements, age, gender);
                        density = 1.1;
                        break;
                    default:
                        throw new Error('Protocolo não implementado');
                }
                
                if (isNaN(bodyFat) || bodyFat < 0 || bodyFat > 60) {
                    throw new Error('Resultado inválido. Verifique os valores inseridos.');
                }
                
                const fatMass = (weight * bodyFat) / 100;
                const leanMass = weight - fatMass;
                const bmi = weight / (height * height);
                
                currentCalculationResult = {
                    bodyFat: bodyFat.toFixed(1),
                    fatMass: fatMass.toFixed(1),
                    leanMass: leanMass.toFixed(1),
                    bmi: bmi.toFixed(1),
                    density: density.toFixed(4),
                    weight,
                    height,
                    age,
                    gender,
                    protocol: currentProtocol,
                    measurements
                };
                
                displayResults(currentCalculationResult);
                
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        // Protocol calculation functions
        function calculateJP3(measurements, age, gender) {
            if (gender === 'male') {
                const sum = measurements.chest + measurements.abdomen + measurements.thigh;
                const density = 1.10938 - (0.0008267 * sum) + (0.0000016 * sum * sum) - (0.0002574 * age);
                const bodyFat = ((4.95 / density) - 4.5) * 100;
                return { bodyFat, density };
            } else {
                const sum = measurements.triceps + measurements.suprailiac + measurements.thigh;
                const density = 1.0994921 - (0.0009929 * sum) + (0.0000023 * sum * sum) - (0.0001392 * age);
                const bodyFat = ((4.95 / density) - 4.5) * 100;
                return { bodyFat, density };
            }
        }

        function calculateJP7(measurements, age, gender) {
            const sum = measurements.chest + measurements.axillary + measurements.triceps + 
                       measurements.subscapular + measurements.abdomen + measurements.suprailiac + measurements.thigh;
            
            if (gender === 'male') {
                const density = 1.112 - (0.00043499 * sum) + (0.00000055 * sum * sum) - (0.00028826 * age);
                const bodyFat = ((4.95 / density) - 4.5) * 100;
                return { bodyFat, density };
            } else {
                const density = 1.097 - (0.00046971 * sum) + (0.00000056 * sum * sum) - (0.00012828 * age);
                const bodyFat = ((4.95 / density) - 4.5) * 100;
                return { bodyFat, density };
            }
        }

        function calculateFaulkner(measurements, gender) {
            const sum = measurements.triceps + measurements.subscapular + measurements.suprailiac + measurements.abdomen;
            return sum * 0.153 + 5.783;
        }

        function calculateDurnin(measurements, age, gender) {
            const sum = measurements.biceps + measurements.triceps + measurements.subscapular + measurements.suprailiac;
            const logSum = Math.log10(sum);
            
            let density = 0;
            if (gender === 'male') {
                if (age >= 17 && age <= 19) {
                    density = 1.1620 - (0.0630 * logSum);
                } else if (age >= 20 && age <= 29) {
                    density = 1.1631 - (0.0632 * logSum);
                } else if (age >= 30 && age <= 39) {
                    density = 1.1422 - (0.0544 * logSum);
                } else if (age >= 40 && age <= 49) {
                    density = 1.1620 - (0.0700 * logSum);
                } else {
                    density = 1.1715 - (0.0779 * logSum);
                }
            } else {
                if (age >= 17 && age <= 19) {
                    density = 1.1549 - (0.0678 * logSum);
                } else if (age >= 20 && age <= 29) {
                    density = 1.1599 - (0.0717 * logSum);
                } else if (age >= 30 && age <= 39) {
                    density = 1.1423 - (0.0632 * logSum);
                } else if (age >= 40 && age <= 49) {
                    density = 1.1333 - (0.0612 * logSum);
                } else {
                    density = 1.1339 - (0.0645 * logSum);
                }
            }
            
            const bodyFat = ((4.95 / density) - 4.5) * 100;
            return { bodyFat, density };
        }

        function calculatePetroski(measurements, age, gender) {
            if (gender === 'male') {
                const sum = measurements.chest + measurements.abdomen + measurements.thigh;
                const density = 1.10726 - (0.0008098 * sum) + (0.0000016 * sum * sum) - (0.0002574 * age);
                const bodyFat = ((4.95 / density) - 4.5) * 100;
                return { bodyFat, density };
            } else {
                const sum = measurements.triceps + measurements.suprailiac + measurements.thigh;
                const density = 1.0994 - (0.0009929 * sum) + (0.0000023 * sum * sum) - (0.0001392 * age);
                const bodyFat = ((4.95 / density) - 4.5) * 100;
                return { bodyFat, density };
            }
        }

        function calculateGuedes(measurements, age, gender) {
            const sum = measurements.triceps + measurements.subscapular;
            
            if (gender === 'male') {
                return (0.735 * sum) + 1.0;
            } else {
                return (0.610 * sum) + 5.1;
            }
        }

        function displayResults(result) {
            const resultsEmpty = document.getElementById('results-empty');
            const resultsContent = document.getElementById('results-content');
            
            if (resultsEmpty) resultsEmpty.classList.add('hidden');
            if (resultsContent) resultsContent.classList.remove('hidden');
            
            const percentage = parseFloat(result.bodyFat);
            const circle = document.getElementById('result-circle');
            if (circle) {
                const circumference = 2 * Math.PI * 58;
                const offset = circumference - (percentage / 100) * circumference;
                circle.style.strokeDashoffset = offset;
            }
            
            const elements = {
                'body-fat-percentage': result.bodyFat,
                'bmi-value': result.bmi,
                'density-value': result.density,
                'fat-mass': result.fatMass + ' kg',
                'lean-mass': result.leanMass + ' kg'
            };
            
            Object.entries(elements).forEach(([id, value]) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            });
            
            const fatBar = document.getElementById('fat-bar');
            const leanBar = document.getElementById('lean-bar');
            if (fatBar) fatBar.style.width = percentage + '%';
            if (leanBar) leanBar.style.width = (100 - percentage) + '%';
            
            const classification = getBodyFatClassification(percentage, result.gender);
            const classificationEl = document.getElementById('fat-classification');
            if (classificationEl) classificationEl.textContent = classification;
        }

        function getBodyFatClassification(percentage, gender) {
            if (gender === 'male') {
                if (percentage < 6) return 'Essencial';
                if (percentage < 14) return 'Atlético';
                if (percentage < 18) return 'Fitness';
                if (percentage < 25) return 'Aceitável';
                return 'Obesidade';
            } else {
                if (percentage < 14) return 'Essencial';
                if (percentage < 21) return 'Atlético';
                if (percentage < 25) return 'Fitness';
                if (percentage < 32) return 'Aceitável';
                return 'Obesidade';
            }
        }

        async function handleSaveEvaluation() {
            if (!currentCalculationResult) {
                showNotification('Calcule a composição corporal primeiro.', 'error');
                return;
            }
            
            const clientId = document.getElementById('client')?.value;
            if (!clientId) {
                showNotification('Selecione um cliente.', 'error');
                return;
            }
            
            try {
                showLoading();
                
                const evaluationData = {
                    client_id: clientId,
                    personal_trainer_id: currentPersonalTrainer.id,
                    protocol: getProtocolName(currentCalculationResult.protocol),
                    age: currentCalculationResult.age,
                    weight: currentCalculationResult.weight,
                    height: currentCalculationResult.height,
                    gender: currentCalculationResult.gender,
                    body_fat_percentage: parseFloat(currentCalculationResult.bodyFat),
                    fat_mass: parseFloat(currentCalculationResult.fatMass),
                    lean_mass: parseFloat(currentCalculationResult.leanMass),
                    bmi: parseFloat(currentCalculationResult.bmi),
                    density: parseFloat(currentCalculationResult.density),
                    measurements: currentCalculationResult.measurements,
                    created_at: new Date().toISOString()
                };
                
                const { data, error } = await supabaseClient
                    .from('shapefit_evaluations')
                    .insert([evaluationData])
                    .select()
                    .single();

                if (error) throw error;

                evaluations.unshift(data);
                
                const client = clients.find(c => c.id === clientId);
                
                // Adicionar atividade
                addRecentActivity(
                    'evaluation_created', 
                    `Nova avaliação realizada - ${currentCalculationResult.bodyFat}% gordura corporal`,
                    client?.name,
                    { bodyFat: currentCalculationResult.bodyFat, protocol: currentCalculationResult.protocol }
                );
                
                renderEvaluations();
                updateDashboardStats();
                
                showNotification('Avaliação salva com sucesso!', 'success');
                hideLoading();
            } catch (error) {
                console.error('Error saving evaluation:', error);
                showNotification('Erro ao salvar avaliação: ' + error.message, 'error');
                hideLoading();
            }
        }

        function generateEvaluationReport() {
            if (!currentCalculationResult) {
                showNotification('Calcule a composição corporal primeiro.', 'error');
                return;
            }
            
            const clientId = document.getElementById('client')?.value;
            if (!clientId) {
                showNotification('Selecione um cliente para gerar o relatório.', 'error');
                return;
            }
            
            const client = clients.find(c => c.id === clientId);
            if (!client) {
                showNotification('Cliente não encontrado.', 'error');
                return;
            }
            
            generatePDFReport(client, currentCalculationResult);
            addRecentActivity('report_generated', `Relatório PDF gerado`, client.name);
        }

        function getProtocolName(protocol) {
            const names = {
                'jp3': 'Jackson-Pollock 3 Dobras',
                'jp7': 'Jackson-Pollock 7 Dobras',
                'faulkner': 'Faulkner',
                'durnin': 'Durnin & Womersley',
                'petroski': 'Petroski',
                'guedes': 'Guedes'
            };
            return names[protocol] || protocol;
        }

        function resetCalculatorForm() {
            const resultsEmpty = document.getElementById('results-empty');
            const resultsContent = document.getElementById('results-content');
            
            if (resultsEmpty) resultsEmpty.classList.remove('hidden');
            if (resultsContent) resultsContent.classList.add('hidden');
            
            document.querySelectorAll('#section-calculator input[type="number"]').forEach(input => input.value = '');
            
            const clientSelect = document.getElementById('client');
            if (clientSelect) clientSelect.value = '';
            
            const maleRadio = document.querySelector('input[name="gender"][value="male"]');
            if (maleRadio) maleRadio.checked = true;
            
            renderProtocolFields(currentProtocol);
            currentCalculationResult = null;
        }

        // --- CLIENT MODAL FUNCTIONS ---
        function openClientModal(clientId = null) {
            const modal = document.getElementById('client-modal');
            const form = document.getElementById('client-form');
            
            if (!modal || !form) return;
            
            form.reset();
            document.getElementById('client-id').value = '';
            
            if (clientId) {
                const client = clients.find(c => c.id === clientId);
                if (client) {
                    document.getElementById('client-modal-title').textContent = 'Editar Cliente';
                    document.getElementById('save-client-btn').textContent = 'Atualizar';
                    document.getElementById('client-id').value = client.id;
                    document.getElementById('client-name').value = client.name;
                    document.getElementById('client-email').value = client.email || '';
                    document.getElementById('client-phone').value = client.phone || '';
                    document.getElementById('client-gender').value = client.gender || '';
                    document.getElementById('client-birth-date').value = client.birth_date || '';
                    document.getElementById('client-notes').value = client.notes || '';
                }
            } else {
                document.getElementById('client-modal-title').textContent = 'Adicionar Cliente';
                document.getElementById('save-client-btn').textContent = 'Salvar';
            }
            
            modal.classList.add('active');
        }

        async function handleClientSave(e) {
            e.preventDefault();
            
            try {
                showLoading();
                
                const clientData = {
                    name: document.getElementById('client-name').value,
                    email: document.getElementById('client-email').value || null,
                    phone: document.getElementById('client-phone').value || null,
                    gender: document.getElementById('client-gender').value || null,
                    birth_date: document.getElementById('client-birth-date').value || null,
                    notes: document.getElementById('client-notes').value || null,
                    status: 'active',
                    personal_trainer_id: currentPersonalTrainer.id,
                    created_at: new Date().toISOString()
                };
                
                const clientId = document.getElementById('client-id').value;
                let result;
                
                if (clientId) {
                    const { data, error } = await supabaseClient
                        .from('shapefit_clients')
                        .update(clientData)
                        .eq('id', clientId)
                        .select()
                        .single();

                    if (error) throw error;
                    result = data;
                    
                    const index = clients.findIndex(c => c.id === clientId);
                    clients[index] = { ...clients[index], ...result };
                    
                    addRecentActivity('client_updated', `Cliente atualizado`, clientData.name);
                } else {
                    const { data, error } = await supabaseClient
                        .from('shapefit_clients')
                        .insert([clientData])
                        .select()
                        .single();

                    if (error) throw error;
                    result = data;
                    result.photos_before = [];
                    result.photos_after = [];
                    
                    clients.unshift(result);
                    
                    addRecentActivity('client_created', `Novo cliente cadastrado`, clientData.name);
                }
                
                renderClients();
                populateClientDropdowns();
                updateDashboardStats();
                
                document.getElementById('client-modal').classList.remove('active');
                showNotification(clientId ? 'Cliente atualizado com sucesso!' : 'Cliente adicionado com sucesso!', 'success');
                
                hideLoading();
            } catch (error) {
                console.error('Error saving client:', error);
                showNotification('Erro ao salvar cliente: ' + error.message, 'error');
                hideLoading();
            }
        }

        async function deleteClient(clientId) {
            showConfirmDialog('Tem certeza que deseja excluir este cliente? Esta ação não pode ser desfeita.', async () => {
                try {
                    showLoading();
                    
                    const { error } = await supabaseClient
                        .from('shapefit_clients')
                        .delete()
                        .eq('id', clientId);

                    if (error) throw error;
                    
                    const client = clients.find(c => c.id === clientId);
                    clients = clients.filter(c => c.id !== clientId);
                    
                    if (client) {
                        addRecentActivity('client_deleted', `Cliente excluído`, client.name);
                    }
                    
                    renderClients();
                    populateClientDropdowns();
                    updateDashboardStats();
                    
                    showNotification('Cliente excluído com sucesso!', 'success');
                    hideLoading();
                } catch (error) {
                    console.error('Error deleting client:', error);
                    showNotification('Erro ao excluir cliente: ' + error.message, 'error');
                    hideLoading();
                }
            });
        }

        // --- CLIENT DETAIL MODAL FUNCTIONS ---
        function openClientDetailModal(clientId) {
            currentClientId = clientId;
            const client = clients.find(c => c.id === clientId);
            if (!client) return;

            document.getElementById('client-detail-title').textContent = client.name;
            document.getElementById('client-detail-subtitle').textContent = `${client.email || 'Sem email'} • ${client.phone || 'Sem telefone'}`;
            
            renderClientDetail(client);
            renderClientPhotos(client);
            document.getElementById('client-detail-modal').classList.add('active');

            // Renderizar evolução se a aba estiver ativa
            const activeTab = document.querySelector('.client-detail-tab-btn.border-green-600');
                if (activeTab && activeTab.dataset.tab === 'evolution') {
                renderClientEvolutionList();
            }
        }
        // --- EVOLUTION FUNCTIONS ---
let selectedEvaluations = [];
let isSelectionMode = false;

function setupEvolutionTab() {
    const selectBtn = document.getElementById('select-evaluations-btn');
    const editBtn = document.getElementById('edit-evaluation-btn');
    const removeBtn = document.getElementById('remove-evaluation-btn');
    const compareBtn = document.getElementById('compare-evaluations-btn');
    const closeComparisonModal = document.getElementById('close-comparison-modal');

    if (selectBtn) {
        selectBtn.addEventListener('click', toggleSelectionMode);
    }

    if (editBtn) {
        editBtn.addEventListener('click', editSelectedEvaluation);
    }

    if (removeBtn) {
        removeBtn.addEventListener('click', removeSelectedEvaluations);
    }

    if (compareBtn) {
        compareBtn.addEventListener('click', compareSelectedEvaluations);
    }

    if (closeComparisonModal) {
        closeComparisonModal.addEventListener('click', () => {
            const modal = document.getElementById('comparison-modal');
            if (modal) modal.classList.remove('active');
        });
    }
}

function toggleSelectionMode() {
    isSelectionMode = !isSelectionMode;
    const selectBtn = document.getElementById('select-evaluations-btn');
    
    if (isSelectionMode) {
        selectBtn.textContent = 'Cancelar Seleção';
        selectBtn.className = 'w-full bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg btn-hover-lift';
    } else {
        selectBtn.innerHTML = '<i class="fas fa-check-square mr-2"></i>Selecionar Avaliações';
        selectBtn.className = 'w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg btn-hover-lift';
        selectedEvaluations = [];
        updateEvolutionButtons();
    }
    
    renderClientEvolutionList();
}

function renderClientEvolutionList() {
    const container = document.getElementById('client-evaluations-selection-list');
    if (!container || !currentClientId) return;
    
    const clientEvals = evaluations.filter(e => e.client_id === currentClientId)
        .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
    
    if (clientEvals.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4 text-gray-500">
                <div class="text-2xl mb-2"><i class="fas fa-clipboard-check"></i></div>
                <p>Nenhuma avaliação encontrada</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = '';
    clientEvals.forEach(evaluation => {
        const isSelected = selectedEvaluations.includes(evaluation.id);
        const checkboxClass = isSelectionMode ? '' : 'hidden';
        const selectionClass = isSelected ? 'bg-blue-50 border-blue-300' : '';
        
        const evalDiv = document.createElement('div');
        evalDiv.className = `evaluation-item p-3 border border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 ${selectionClass}`;
        evalDiv.innerHTML = `
            <div class="flex items-center justify-between">
                <input type="checkbox" class="evaluation-checkbox ${checkboxClass}" 
                       data-eval-id="${evaluation.id}" ${isSelected ? 'checked' : ''}>
                <div class="flex-1 ${isSelectionMode ? 'ml-3' : ''}">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-medium">${new Date(evaluation.created_at).toLocaleDateString('pt-BR')}</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400">${evaluation.protocol}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold text-green-600">${evaluation.body_fat_percentage}%</p>
                            <p class="text-sm text-gray-500">${evaluation.weight} kg</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        if (isSelectionMode) {
            const checkbox = evalDiv.querySelector('.evaluation-checkbox');
            checkbox.addEventListener('change', function() {
                handleEvaluationSelection(evaluation.id, this.checked);
            });
        }
        
        container.appendChild(evalDiv);
    });
    
    renderClientEvolutionChart();
}

function handleEvaluationSelection(evaluationId, isSelected) {
    if (isSelected) {
        if (!selectedEvaluations.includes(evaluationId)) {
            selectedEvaluations.push(evaluationId);
        }
    } else {
        selectedEvaluations = selectedEvaluations.filter(id => id !== evaluationId);
    }
    
    updateEvolutionButtons();
    renderClientEvolutionList();
}

function updateEvolutionButtons() {
    const editBtn = document.getElementById('edit-evaluation-btn');
    const removeBtn = document.getElementById('remove-evaluation-btn');
    const compareBtn = document.getElementById('compare-evaluations-btn');
    
    const hasSelection = selectedEvaluations.length > 0;
    const hasMultipleSelection = selectedEvaluations.length > 1;
    
    if (editBtn) {
        editBtn.disabled = selectedEvaluations.length !== 1;
        editBtn.className = selectedEvaluations.length === 1 
            ? 'w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg btn-hover-lift'
            : 'w-full bg-gray-400 text-gray-200 py-2 px-4 rounded-lg cursor-not-allowed';
    }
    
    if (removeBtn) {
        removeBtn.disabled = !hasSelection;
        removeBtn.className = hasSelection 
            ? 'w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg btn-hover-lift'
            : 'w-full bg-gray-400 text-gray-200 py-2 px-4 rounded-lg cursor-not-allowed';
    }
    
    if (compareBtn) {
        compareBtn.disabled = !hasMultipleSelection;
        compareBtn.className = hasMultipleSelection 
            ? 'w-full bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-lg btn-hover-lift'
            : 'w-full bg-gray-400 text-gray-200 py-2 px-4 rounded-lg cursor-not-allowed';
    }
}

function editSelectedEvaluation() {
    if (selectedEvaluations.length !== 1) return;
    
    const evaluationId = selectedEvaluations[0];
    const evaluation = evaluations.find(e => e.id === evaluationId);
    if (!evaluation) return;
    
    // Preencher o formulário da calculadora com os dados da avaliação
    document.getElementById('client').value = evaluation.client_id;
    document.getElementById('age').value = evaluation.age;
    document.getElementById('weight').value = evaluation.weight;
    document.getElementById('height').value = evaluation.height;
    
    // Selecionar o sexo
    const genderRadio = document.querySelector(`input[name="gender"][value="${evaluation.gender}"]`);
    if (genderRadio) genderRadio.checked = true;
    
    // Ir para a calculadora
    const navCalculator = document.getElementById('nav-calculator');
    if (navCalculator) navCalculator.click();
    
    // Fechar modal
    const detailModal = document.getElementById('client-detail-modal');
    if (detailModal) detailModal.classList.remove('active');
    
    showNotification('Dados da avaliação carregados na calculadora', 'info');
}

function removeSelectedEvaluations() {
    if (selectedEvaluations.length === 0) return;
    
    const count = selectedEvaluations.length;
    const message = count === 1 
        ? 'Tem certeza que deseja remover esta avaliação?' 
        : `Tem certeza que deseja remover ${count} avaliações?`;
    
    showConfirmDialog(message, async () => {
        try {
            showLoading();
            
            for (const evaluationId of selectedEvaluations) {
                const { error } = await supabaseClient
                    .from('shapefit_evaluations')
                    .delete()
                    .eq('id', evaluationId);

                if (error) throw error;
            }
            
            // Remover das arrays locais
            evaluations = evaluations.filter(e => !selectedEvaluations.includes(e.id));
            selectedEvaluations = [];
            
            renderEvaluations();
            renderClientEvolutionList();
            updateEvolutionButtons();
            updateDashboardStats();
            
            showNotification(`${count} avaliação(ões) removida(s) com sucesso!`, 'success');
            hideLoading();
        } catch (error) {
            console.error('Error removing evaluations:', error);
            showNotification('Erro ao remover avaliações: ' + error.message, 'error');
            hideLoading();
        }
    });
}

function compareSelectedEvaluations() {
    if (selectedEvaluations.length < 2) return;
    
    const selectedEvals = evaluations.filter(e => selectedEvaluations.includes(e.id))
        .sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
    
    const comparisonContent = document.getElementById('comparison-content');
    if (!comparisonContent) return;
    
    comparisonContent.innerHTML = '';
    
    selectedEvals.forEach((evaluation, index) => {
        const evalDiv = document.createElement('div');
        evalDiv.className = 'bg-white dark:bg-gray-700 p-4 rounded-lg shadow';
        evalDiv.innerHTML = `
            <h4 class="font-semibold mb-3">Avaliação ${index + 1}</h4>
            <div class="text-sm text-gray-600 dark:text-gray-400 mb-3">${new Date(evaluation.created_at).toLocaleDateString('pt-BR')}</div>
            <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                    <span>Protocolo:</span>
                    <span class="font-medium">${evaluation.protocol}</span>
                </div>
                <div class="flex justify-between">
                    <span>Gordura Corporal:</span>
                    <span class="font-bold text-green-600">${evaluation.body_fat_percentage}%</span>
                </div>
                <div class="flex justify-between">
                    <span>Peso:</span>
                    <span class="font-medium">${evaluation.weight} kg</span>
                </div>
                <div class="flex justify-between">
                    <span>IMC:</span>
                    <span class="font-medium">${evaluation.bmi}</span>
                </div>
                <div class="flex justify-between">
                    <span>Massa Gorda:</span>
                    <span class="font-medium">${evaluation.fat_mass} kg</span>
                </div>
                <div class="flex justify-between">
                    <span>Massa Magra:</span>
                    <span class="font-medium">${evaluation.lean_mass} kg</span>
                </div>
            </div>
        `;
        comparisonContent.appendChild(evalDiv);
    });
    
    // Adicionar análise de diferenças se houver 2 avaliações
    if (selectedEvals.length === 2) {
        const [first, last] = selectedEvals;
        const weightDiff = (last.weight - first.weight).toFixed(1);
        const fatDiff = (last.body_fat_percentage - first.body_fat_percentage).toFixed(1);
        const leanDiff = (last.lean_mass - first.lean_mass).toFixed(1);
        
        const analysisDiv = document.createElement('div');
        analysisDiv.className = 'col-span-full bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg mt-4';
        analysisDiv.innerHTML = `
            <h4 class="font-semibold mb-3">Análise Comparativa</h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                <div class="text-center">
                    <p class="text-gray-600 dark:text-gray-400">Diferença de Peso</p>
                    <p class="text-lg font-bold ${weightDiff >= 0 ? 'text-red-600' : 'text-green-600'}">
                        ${weightDiff >= 0 ? '+' : ''}${weightDiff} kg
                    </p>
                </div>
                <div class="text-center">
                    <p class="text-gray-600 dark:text-gray-400">Diferença de Gordura</p>
                    <p class="text-lg font-bold ${fatDiff >= 0 ? 'text-red-600' : 'text-green-600'}">
                        ${fatDiff >= 0 ? '+' : ''}${fatDiff}%
                    </p>
                </div>
                <div class="text-center">
                    <p class="text-gray-600 dark:text-gray-400">Diferença de Massa Magra</p>
                    <p class="text-lg font-bold ${leanDiff >= 0 ? 'text-green-600' : 'text-red-600'}">
                        ${leanDiff >= 0 ? '+' : ''}${leanDiff} kg
                    </p>
                </div>
            </div>
        `;
        comparisonContent.appendChild(analysisDiv);
    }
    
    const modal = document.getElementById('comparison-modal');
    if (modal) modal.classList.add('active');
}

function renderClientEvolutionChart() {
    if (!currentClientId) return;
    
    const ctx = document.getElementById('clientEvolutionDetailChart');
    if (!ctx) return;
    
    if (window.clientEvolutionDetailChart) {
        window.clientEvolutionDetailChart.destroy();
    }
    
    const clientEvals = evaluations.filter(e => e.client_id === currentClientId)
        .sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
    
    if (clientEvals.length === 0) {
        ctx.style.display = 'none';
        return;
    }
    
    ctx.style.display = 'block';
    
    const labels = clientEvals.map(e => new Date(e.created_at).toLocaleDateString('pt-BR'));
    const bodyFatData = clientEvals.map(e => e.body_fat_percentage);
    const weightData = clientEvals.map(e => e.weight);
    
    window.clientEvolutionDetailChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Gordura Corporal (%)',
                    data: bodyFatData,
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    tension: 0.3,
                    yAxisID: 'y'
                },
                {
                    label: 'Peso (kg)',
                    data: weightData,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.3,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Gordura Corporal (%)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Peso (kg)'
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            }
        }
    });
}

        function renderClientDetail(client) {
            const overviewInfo = document.getElementById('client-overview-info');
            const age = client.birth_date ? Math.floor((new Date() - new Date(client.birth_date)) / (365.25 * 24 * 60 * 60 * 1000)) : 'Não informada';
            
            if (overviewInfo) {
                overviewInfo.innerHTML = `
                    <div><strong>Email:</strong> ${client.email || 'Não informado'}</div>
                    <div><strong>Telefone:</strong> ${client.phone || 'Não informado'}</div>
                    <div><strong>Sexo:</strong> ${client.gender || 'Não informado'}</div>
                    <div><strong>Idade:</strong> ${age} anos</div>
                    <div><strong>Status:</strong> ${client.status === 'active' ? 'Ativo' : 'Inativo'}</div>
                `;
            }

            const overviewEval = document.getElementById('client-overview-eval');
            const lastEval = evaluations.find(e => e.client_id === client.id);
            
            if (overviewEval) {
                if (lastEval) {
                    overviewEval.innerHTML = `
                        <div class="text-3xl font-bold text-green-600 mb-2">${lastEval.body_fat_percentage}%</div>
                        <div class="text-sm text-gray-500">Gordura Corporal</div>
                        <div class="text-xs text-gray-400 mt-2">${new Date(lastEval.created_at).toLocaleDateString('pt-BR')}</div>
                    `;
                } else {
                    overviewEval.innerHTML = `
                        <div class="text-gray-500">
                            <div class="text-2xl mb-2"><i class="fas fa-clipboard-check"></i></div>
                            <div class="text-sm">Nenhuma avaliação</div>
                        </div>
                    `;
                }
            }

            const overviewWorkouts = document.getElementById('client-overview-workouts');
            const clientWorkouts = workouts.filter(w => w.client_id === client.id && w.status === 'active');
            
            if (overviewWorkouts) {
                if (clientWorkouts.length > 0) {
                    overviewWorkouts.innerHTML = `
                        <div class="text-3xl font-bold text-blue-600 mb-2">${clientWorkouts.length}</div>
                        <div class="text-sm text-gray-500">Treinos Ativos</div>
                    `;
                } else {
                    overviewWorkouts.innerHTML = `
                        <div class="text-gray-500">
                            <div class="text-2xl mb-2"><i class="fas fa-dumbbell"></i></div>
                            <div class="text-sm">Nenhum treino</div>
                        </div>
                    `;
                }
            }

            const evalsList = document.getElementById('client-evaluations-list');
            const clientEvals = evaluations.filter(e => e.client_id === client.id);
            
            if (evalsList) {
                if (clientEvals.length === 0) {
                    evalsList.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <div class="text-4xl mb-2"><i class="fas fa-clipboard-check"></i></div>
                            <p>Nenhuma avaliação realizada</p>
                        </div>
                    `;
                } else {
                    evalsList.innerHTML = '';
                    clientEvals.forEach(evaluation => {
                        evalsList.innerHTML += `
                            <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow border-l-4 border-green-500">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-semibold">Avaliação ${new Date(evaluation.created_at).toLocaleDateString('pt-BR')}</h4>
                                    <span class="text-xs text-gray-500">${evaluation.protocol}</span>
                                </div>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <span class="text-gray-600 dark:text-gray-400">Gordura Corporal:</span>
                                        <span class="font-semibold ml-2">${evaluation.body_fat_percentage}%</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-600 dark:text-gray-400">Peso:</span>
                                        <span class="font-semibold ml-2">${evaluation.weight} kg</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-600 dark:text-gray-400">IMC:</span>
                                        <span class="font-semibold ml-2">${evaluation.bmi}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-600 dark:text-gray-400">Massa Magra:</span>
                                        <span class="font-semibold ml-2">${evaluation.lean_mass} kg</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
            }

            const workoutsList = document.getElementById('client-workouts-list');
            const clientWorkoutsList = workouts.filter(w => w.client_id === client.id);
            
            if (workoutsList) {
                if (clientWorkoutsList.length === 0) {
                    workoutsList.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <div class="text-4xl mb-2"><i class="fas fa-dumbbell"></i></div>
                            <p>Nenhum treino cadastrado</p>
                            <button class="bg-blue-600 text-white px-4 py-2 rounded-lg mt-2" onclick="openWorkoutModal(null, '${client.id}')">
                                <i class="fas fa-plus mr-2"></i>
                                Criar Primeiro Treino
                            </button>
                        </div>
                    `;
                } else {
                    workoutsList.innerHTML = '';
                    clientWorkoutsList.forEach(workout => {
                        const statusColor = workout.status === 'active' ? 'green' : 'yellow';
                        const statusText = workout.status === 'active' ? 'Ativo' : 'Pausado';
                        
                        workoutsList.innerHTML += `
                            <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow border-l-4 border-${statusColor}-500 mb-4">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-semibold">${workout.name}</h4>
                                    <span class="px-2 py-1 text-xs bg-${statusColor}-100 text-${statusColor}-800 rounded-full">${statusText}</span>
                                </div>
                                <div class="text-sm text-gray-600 dark:text-gray-400 mb-2">${workout.type} • ${workout.duration || 60} min</div>
                                <div class="text-sm">${workout.exercises ? workout.exercises.length : 0} exercícios</div>
                            </div>
                        `;
                    });
                }
            }
        }

        function renderClientPhotos(client) {
            const beforeContainer = document.getElementById('client-photos-before');
            const afterContainer = document.getElementById('client-photos-after');
            
            if (!beforeContainer || !afterContainer) return;
            
            beforeContainer.innerHTML = '';
            afterContainer.innerHTML = '';
            
            const addBeforeBtn = document.createElement('div');
            addBeforeBtn.className = 'add-image-btn';
            addBeforeBtn.innerHTML = `
                <i class="fas fa-plus text-2xl text-gray-400 mb-2"></i>
                <span class="text-sm text-gray-500">Adicionar Fotos</span>
            `;
            addBeforeBtn.onclick = () => handleAddImageClick('before');
            beforeContainer.appendChild(addBeforeBtn);
            
            const addAfterBtn = document.createElement('div');
            addAfterBtn.className = 'add-image-btn';
            addAfterBtn.innerHTML = `
                <i class="fas fa-plus text-2xl text-gray-400 mb-2"></i>
                <span class="text-sm text-gray-500">Adicionar Fotos</span>
            `;
            addAfterBtn.onclick = () => handleAddImageClick('after');
            afterContainer.appendChild(addAfterBtn);
            
            if (client.photos_before && client.photos_before.length > 0) {
                client.photos_before.forEach((photo, index) => {
                    const photoDiv = document.createElement('div');
                    photoDiv.className = 'image-gallery-item';
                    photoDiv.innerHTML = `
                        <img src="${photo}" alt="Foto antes ${index + 1}">
                        <button class="delete-btn" onclick="deleteClientPhoto('${client.id}', 'before', ${index})">
                            <i class="fas fa-trash text-xs"></i>
                        </button>
                    `;
                    beforeContainer.insertBefore(photoDiv, addBeforeBtn);
                });
            }
            
            if (client.photos_after && client.photos_after.length > 0) {
                client.photos_after.forEach((photo, index) => {
                    const photoDiv = document.createElement('div');
                    photoDiv.className = 'image-gallery-item';
                    photoDiv.innerHTML = `
                        <img src="${photo}" alt="Foto depois ${index + 1}">
                        <button class="delete-btn" onclick="deleteClientPhoto('${client.id}', 'after', ${index})">
                            <i class="fas fa-trash text-xs"></i>
                        </button>
                    `;
                    afterContainer.insertBefore(photoDiv, addAfterBtn);
                });
            }
        }

        window.handleAddImageClick = async function(type) {
            if (!currentClientId) {
                showNotification('Erro: Cliente não selecionado', 'error');
                return;
            }
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.multiple = true;
            
            input.onchange = async function(e) {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;
                
                try {
                    showLoading();
                    
                    for (const file of files) {
                        const imageBase64 = await handleImageUpload(file);
                        if (imageBase64) {
                            const { data, error } = await supabaseClient
                                .from('shapefit_client_photos')
                                .insert([{
                                    client_id: currentClientId,
                                    photo_type: type,
                                    photo_url: imageBase64,
                                    created_at: new Date().toISOString()
                                }])
                                .select()
                                .single();

                            if (error) throw error;
                            
                            const client = clients.find(c => c.id === currentClientId);
                            if (client) {
                                if (type === 'before') {
                                    client.photos_before = client.photos_before || [];
                                    client.photos_before.push(imageBase64);
                                } else {
                                    client.photos_after = client.photos_after || [];
                                    client.photos_after.push(imageBase64);
                                }
                                renderClientPhotos(client);
                            }
                        }
                    }
                    
                    const client = clients.find(c => c.id === currentClientId);
                    addRecentActivity('photo_uploaded', `${files.length} foto(s) adicionada(s)`, client?.name);
                    
                    showNotification(`${files.length} foto(s) adicionada(s) com sucesso!`, 'success');
                    hideLoading();
                } catch (error) {
                    console.error('Error uploading photos:', error);
                    showNotification('Erro ao adicionar fotos: ' + error.message, 'error');
                    hideLoading();
                }
            };
            
            input.click();
        };

        window.deleteClientPhoto = async function(clientId, type, index) {
            showConfirmDialog('Tem certeza que deseja excluir esta foto?', async () => {
                try {
                    showLoading();
                    
                    const client = clients.find(c => c.id === clientId);
                    const photos = type === 'before' ? client.photos_before : client.photos_after;
                    const photoUrl = photos[index];
                    
                    const { data: photosData, error: fetchError } = await supabaseClient
                        .from('shapefit_client_photos')
                        .select('id, photo_url')
                        .eq('client_id', clientId)
                        .eq('photo_type', type);
        
                    if (fetchError) throw fetchError;
                    
                    const photoRecord = photosData.find(photo => {
                        const storedUrl = photo.photo_url.substring(0, 100);
                        const targetUrl = photoUrl.substring(0, 100);
                        return storedUrl === targetUrl;
                    });
                    
                    if (!photoRecord) {
                        throw new Error('Foto não encontrada no banco de dados');
                    }
                    
                    const { error } = await supabaseClient
                        .from('shapefit_client_photos')
                        .delete()
                        .eq('id', photoRecord.id);
        
                    if (error) throw error;
                    
                    photos.splice(index, 1);
                    renderClientPhotos(client);
                    
                    showNotification('Foto excluída com sucesso!', 'success');
                    hideLoading();
                } catch (error) {
                    console.error('Error deleting photo:', error);
                    showNotification('Erro ao excluir foto: ' + error.message, 'error');
                    hideLoading();
                }
            });
        };

        // --- WORKOUT FUNCTIONS ---
        function populateExerciseDatabase() {
            const container = document.getElementById('exercise-categories');
            if (!container) return;
            
            container.innerHTML = '';
            
            Object.keys(exerciseDatabase).forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'exercise-category';
                categoryDiv.innerHTML = `
                    <h5 class="font-medium text-sm mb-2 text-gray-700 dark:text-gray-300">${category}</h5>
                    <div class="space-y-1">
                        ${exerciseDatabase[category].map(exercise => `
                            <div class="exercise-item p-2 border border-gray-200 dark:border-gray-600 rounded text-xs cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" 
                                 data-exercise='${JSON.stringify(exercise)}'>
                                <div class="font-medium">${exercise.name}</div>
                                <div class="text-gray-500">${exercise.equipment} • ${exercise.muscle}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(categoryDiv);
            });
            
            container.querySelectorAll('.exercise-item').forEach(item => {
                item.addEventListener('click', function() {
                    const exercise = JSON.parse(this.dataset.exercise);
                    addExerciseToWorkout(exercise);
                    this.classList.toggle('selected');
                });
            });
        }

        function addExerciseToWorkout(exercise) {
            const container = document.getElementById('workout-exercises');
            const existingText = container.querySelector('.text-center');
            if (existingText) existingText.remove();
            
            const existingExercise = selectedExercises.find(e => e.name === exercise.name);
            if (existingExercise) {
                showNotification('Exercício já adicionado ao treino', 'warning');
                return;
            }
            
            selectedExercises.push({
                name: exercise.name,
                sets: '3',
                reps: '12',
                weight: '',
                rest: '60s'
            });
            
            renderSelectedExercises();
        }

        function renderSelectedExercises() {
            const container = document.getElementById('workout-exercises');
            
            if (selectedExercises.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500">Nenhum exercício selecionado</div>';
                return;
            }
            
            container.innerHTML = '';
            selectedExercises.forEach((exercise, index) => {
                const exerciseDiv = document.createElement('div');
                exerciseDiv.className = 'flex items-center space-x-2 p-2 bg-gray-50 dark:bg-gray-600 rounded';
                exerciseDiv.innerHTML = `
                    <div class="flex-1 font-medium text-sm">${exercise.name}</div>
                    <input type="text" value="${exercise.sets}" placeholder="Séries" class="w-16 p-1 text-xs border rounded text-center" onchange="updateExercise(${index}, 'sets', this.value)">
                    <input type="text" value="${exercise.reps}" placeholder="Reps" class="w-16 p-1 text-xs border rounded text-center" onchange="updateExercise(${index}, 'reps', this.value)">
                    <input type="text" value="${exercise.weight}" placeholder="Peso" class="w-20 p-1 text-xs border rounded text-center" onchange="updateExercise(${index}, 'weight', this.value)">
                    <input type="text" value="${exercise.rest}" placeholder="Descanso" class="w-16 p-1 text-xs border rounded text-center" onchange="updateExercise(${index}, 'rest', this.value)">
                    <button onclick="removeExercise(${index})" class="text-red-500 hover:text-red-700 p-1">
                        <i class="fas fa-trash text-xs"></i>
                    </button>
                `;
                container.appendChild(exerciseDiv);
            });
        }

        function updateExercise(index, field, value) {
            if (selectedExercises[index]) {
                selectedExercises[index][field] = value;
            }
        }

        function removeExercise(index) {
            selectedExercises.splice(index, 1);
            renderSelectedExercises();
        }

        function openWorkoutModal(workoutId = null, preSelectedClientId = null) {
            const modal = document.getElementById('workout-modal');
            const form = document.getElementById('workout-form');
            
            if (!modal || !form) return;
            
            form.reset();
            document.getElementById('workout-id').value = '';
            selectedExercises = [];
            
            if (workoutId) {
                const workout = workouts.find(w => w.id === workoutId);
                if (workout) {
                    document.getElementById('workout-modal-title').textContent = 'Editar Treino';
                    document.getElementById('save-workout-btn').textContent = 'Atualizar';
                    document.getElementById('workout-id').value = workout.id;
                    document.getElementById('workout-name').value = workout.name;
                    document.getElementById('workout-client').value = workout.client_id;
                    document.getElementById('workout-type').value = workout.type || '';
                    document.getElementById('workout-duration').value = workout.duration || 60;
                    document.getElementById('workout-description').value = workout.description || '';
                    
                    if (workout.exercises) {
                        selectedExercises = [...workout.exercises];
                    }
                }
            } else {
                document.getElementById('workout-modal-title').textContent = 'Criar Treino';
                document.getElementById('save-workout-btn').textContent = 'Salvar Treino';
                
                if (preSelectedClientId) {
                    document.getElementById('workout-client').value = preSelectedClientId;
                }
            }
            
            populateExerciseDatabase();
            renderSelectedExercises();
            modal.classList.add('active');
        }

        async function handleWorkoutSave(e) {
            e.preventDefault();
            
            try {
                showLoading();
                
                const workoutData = {
                    name: document.getElementById('workout-name').value,
                    client_id: document.getElementById('workout-client').value,
                    personal_trainer_id: currentPersonalTrainer.id,
                    type: document.getElementById('workout-type').value,
                    duration: parseInt(document.getElementById('workout-duration').value) || 60,
                    description: document.getElementById('workout-description').value || null,
                    exercises: selectedExercises,
                    status: 'active',
                    created_at: new Date().toISOString()
                };
                
                const workoutId = document.getElementById('workout-id').value;
                let result;
                const client = clients.find(c => c.id === workoutData.client_id);
                
                if (workoutId) {
                    const { data, error } = await supabaseClient
                        .from('shapefit_workouts')
                        .update(workoutData)
                        .eq('id', workoutId)
                        .select()
                        .single();

                    if (error) throw error;
                    result = data;
                    
                    const index = workouts.findIndex(w => w.id === workoutId);
                    workouts[index] = { ...workouts[index], ...result };
                    
                    addRecentActivity('workout_updated', `Treino atualizado: ${workoutData.name}`, client?.name);
                } else {
                    const { data, error } = await supabaseClient
                        .from('shapefit_workouts')
                        .insert([workoutData])
                        .select()
                        .single();

                    if (error) throw error;
                    result = data;
                    
                    workouts.unshift(result);
                    
                    addRecentActivity('workout_created', `Novo treino criado: ${workoutData.name}`, client?.name);
                }
                
                renderWorkouts();
                updateDashboardStats();
                
                document.getElementById('workout-modal').classList.remove('active');
                showNotification(workoutId ? 'Treino atualizado com sucesso!' : 'Treino criado com sucesso!', 'success');
                
                hideLoading();
            } catch (error) {
                console.error('Error saving workout:', error);
                showNotification('Erro ao salvar treino: ' + error.message, 'error');
                hideLoading();
            }
        }

        function viewWorkout(workoutId) {
            const workout = workouts.find(w => w.id === workoutId);
            if (!workout) return;
            
            const client = clients.find(c => c.id === workout.client_id);
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content p-6 rounded-lg max-w-2xl w-full mx-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">${workout.name}</h3>
                        <button class="close-modal text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><strong>Cliente:</strong> ${client?.name || 'N/A'}</div>
                            <div><strong>Tipo:</strong> ${workout.type}</div>
                            <div><strong>Duração:</strong> ${workout.duration} min</div>
                            <div><strong>Status:</strong> ${workout.status === 'active' ? 'Ativo' : 'Pausado'}</div>
                        </div>
                        ${workout.description ? `
                            <div>
                                <strong>Descrição:</strong>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">${workout.description}</p>
                            </div>
                        ` : ''}
                        <div>
                            <h4 class="font-semibold mb-2">Exercícios:</h4>
                            <div class="space-y-2 max-h-60 overflow-y-auto">
                                ${workout.exercises ? workout.exercises.map(ex => `
                                    <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded">
                                        <div class="font-medium">${ex.name}</div>
                                        <div class="text-sm text-gray-600 dark:text-gray-400">
                                            ${ex.sets} séries × ${ex.reps} repetições
                                            ${ex.weight ? ` - ${ex.weight}` : ''}
                                            ${ex.rest ? ` - Descanso: ${ex.rest}` : ''}
                                        </div>
                                    </div>
                                `).join('') : '<div class="text-gray-500">Nenhum exercício cadastrado</div>'}
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end mt-6">
                        <button class="close-modal px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg">Fechar</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.querySelectorAll('.close-modal').forEach(btn => {
                btn.onclick = () => modal.remove();
            });
            
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
        }

        async function deleteWorkout(workoutId) {
            showConfirmDialog('Tem certeza que deseja excluir este treino?', async () => {
                try {
                    showLoading();
                    
                    const { error } = await supabaseClient
                        .from('shapefit_workouts')
                        .delete()
                        .eq('id', workoutId);

                    if (error) throw error;
                    
                    workouts = workouts.filter(w => w.id !== workoutId);
                    
                    renderWorkouts();
                    updateDashboardStats();
                    
                    showNotification('Treino excluído com sucesso!', 'success');
                    hideLoading();
                } catch (error) {
                    console.error('Error deleting workout:', error);
                    showNotification('Erro ao excluir treino: ' + error.message, 'error');
                    hideLoading();
                }
            });
        }

        // --- APPOINTMENT MODAL FUNCTIONS ---
        function openAppointmentModal(selectedDate = null, appointmentId = null) {
            const modal = document.getElementById('appointment-modal');
            const form = document.getElementById('appointment-form');
            
            if (!modal || !form) return;
            
            form.reset();
            document.getElementById('appointment-id').value = '';
            
            if (appointmentId) {
                const appointment = appointments.find(a => a.id === appointmentId);
                if (appointment) {
                    document.getElementById('appointment-modal-title').textContent = 'Editar Agendamento';
                    document.getElementById('save-appointment-btn').textContent = 'Atualizar';
                    document.getElementById('appointment-id').value = appointment.id;
                    document.getElementById('appointment-client').value = appointment.client_id;
                    document.getElementById('appointment-date').value = appointment.date;
                    document.getElementById('appointment-time').value = appointment.time;
                    document.getElementById('appointment-type').value = appointment.type;
                    document.getElementById('appointment-notes').value = appointment.notes || '';
                }
            } else {
                document.getElementById('appointment-modal-title').textContent = 'Novo Agendamento';
                document.getElementById('save-appointment-btn').textContent = 'Salvar Agendamento';
                
                if (selectedDate) {
                    document.getElementById('appointment-date').value = selectedDate;
                } else {
                    // Se não há data selecionada, usar hoje
                    const today = new Date();
                    const todayString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                    document.getElementById('appointment-date').value = todayString;
                }
            }
            
            modal.classList.add('active');
        }
        async function handleAppointmentSave(e) {
            e.preventDefault();
            
            try {
                showLoading();
                
                const dateInput = document.getElementById('appointment-date').value;
                const timeInput = document.getElementById('appointment-time').value;
                
                if (!dateInput || !timeInput) {
                    throw new Error('Data e horário são obrigatórios');
                }
                
                const appointmentData = {
                    client_id: document.getElementById('appointment-client').value,
                    personal_trainer_id: currentPersonalTrainer.id,
                    date: dateInput, // Usar a data exatamente como inserida
                    time: timeInput,
                    type: document.getElementById('appointment-type').value,
                    notes: document.getElementById('appointment-notes').value || null,
                    status: 'scheduled',
                    created_at: new Date().toISOString()
                };
                
                const appointmentId = document.getElementById('appointment-id').value;
                let result;
                const client = clients.find(c => c.id === appointmentData.client_id);
                
                if (appointmentId) {
                    const { data, error } = await supabaseClient
                        .from('shapefit_appointments')
                        .update(appointmentData)
                        .eq('id', appointmentId)
                        .select()
                        .single();
        
                    if (error) throw error;
                    result = data;
                    
                    const index = appointments.findIndex(a => a.id === appointmentId);
                    appointments[index] = { ...appointments[index], ...result };
                    
                    addRecentActivity('appointment_updated', `Agendamento atualizado`, client?.name);
                } else {
                    const { data, error } = await supabaseClient
                        .from('shapefit_appointments')
                        .insert([appointmentData])
                        .select()
                        .single();
        
                    if (error) throw error;
                    result = data;
                    
                    appointments.push(result);
                    
                    addRecentActivity('appointment_created', `Novo agendamento criado`, client?.name);
                }
                
                renderCalendar();
                renderUpcomingAppointments();
                updateDashboardStats();
                
                document.getElementById('appointment-modal').classList.remove('active');
                showNotification(appointmentId ? 'Agendamento atualizado com sucesso!' : 'Agendamento criado com sucesso!', 'success');
                
                hideLoading();
            } catch (error) {
                console.error('Error saving appointment:', error);
                showNotification('Erro ao salvar agendamento: ' + error.message, 'error');
                hideLoading();
            }
        }

        async function deleteAppointment(appointmentId) {
            showConfirmDialog('Tem certeza que deseja excluir este agendamento?', async () => {
                try {
                    showLoading();
                    
                    const { error } = await supabaseClient
                        .from('shapefit_appointments')
                        .delete()
                        .eq('id', appointmentId);

                    if (error) throw error;
                    
                    appointments = appointments.filter(a => a.id !== appointmentId);
                    
                    renderCalendar();
                    renderUpcomingAppointments();
                    updateDashboardStats();
                    
                    showNotification('Agendamento excluído com sucesso!', 'success');
                    hideLoading();
                } catch (error) {
                    console.error('Error deleting appointment:', error);
                    showNotification('Erro ao excluir agendamento: ' + error.message, 'error');
                    hideLoading();
                }
            });
        }

        // --- PROFILE FUNCTIONS ---
        async function handleProfileSave(e) {
            e.preventDefault();
            
            try {
                showLoading();
                
                const profileData = {
                    name: document.getElementById('profile-name').value,
                    phone: document.getElementById('profile-phone').value || null,
                    cref: document.getElementById('profile-cref').value || null,
                    specialties: document.getElementById('profile-specialties').value || null
                };
                
                const { error } = await supabaseClient
                    .from('shapefit_personal_trainers')
                    .update(profileData)
                    .eq('id', currentPersonalTrainer.id);

                if (error) throw error;

                Object.assign(currentPersonalTrainer, profileData);
                
                const userName = document.getElementById('user-name');
                if (userName) userName.textContent = profileData.name || 'Personal Trainer';
                
                addRecentActivity('profile_updated', 'Perfil atualizado');
                
                showNotification('Perfil atualizado com sucesso!', 'success');
                hideLoading();
            } catch (error) {
                console.error('Error saving profile:', error);
                showNotification('Erro ao salvar perfil: ' + error.message, 'error');
                hideLoading();
            }
        }

        async function handleProfileImageUpload(file) {
            try {
                const imageBase64 = await handleImageUpload(file, 'profile');
                if (imageBase64) {
                    const { error } = await supabaseClient
                        .from('shapefit_personal_trainers')
                        .update({ avatar_url: imageBase64 })
                        .eq('id', currentPersonalTrainer.id);

                    if (error) throw error;

                    currentPersonalTrainer.avatar_url = imageBase64;
                    
                    const profileImagePreview = document.getElementById('profile-image-preview');
                    const userAvatar = document.getElementById('user-avatar');
                    
                    if (profileImagePreview) profileImagePreview.src = imageBase64;
                    if (userAvatar) userAvatar.src = imageBase64;
                    
                    showNotification('Foto de perfil atualizada com sucesso!', 'success');
                }
            } catch (error) {
                console.error('Error updating profile image:', error);
                showNotification('Erro ao atualizar foto de perfil: ' + error.message, 'error');
            }
        }

        // --- AUTHENTICATION ---
        async function handleLogin(email, password) {
            try {
                const loginBtn = document.getElementById('login-btn');
                const loginBtnText = document.getElementById('login-btn-text');
                const loginSpinner = document.getElementById('login-spinner');
                
                if (loginBtn) loginBtn.disabled = true;
                if (loginBtnText) loginBtnText.textContent = 'Entrando...';
                if (loginSpinner) loginSpinner.style.display = 'block';
                
                if (!email || !password) {
                    throw new Error('Preencha todos os campos');
                }
        
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    throw new Error('Digite um email válido');
                }
        
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });
        
                if (error) {
                    throw new Error(error.message);
                }
                
                currentUser = data.user;
                
                let personalTrainer = await getPersonalTrainerByEmail(email);
                if (!personalTrainer) {
                    const name = email.split('@')[0].replace(/[^a-zA-Z0-9]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    personalTrainer = await createPersonalTrainer(email, name);
                }
                
                currentPersonalTrainer = personalTrainer;
                
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                
                showNotification('Login realizado com sucesso!', 'success');
                
                await loadUserData();
                setupCalculator();
                loadDashboard();
                
                // Adicionar atividade de login
                addRecentActivity('login', 'Login realizado com sucesso');
                
            } catch (error) {
                console.error('Error logging in:', error);
                showLoginError(error.message);
            } finally {
                const loginBtn = document.getElementById('login-btn');
                const loginBtnText = document.getElementById('login-btn-text');
                const loginSpinner = document.getElementById('login-spinner');
                
                if (loginBtn) loginBtn.disabled = false;
                if (loginBtnText) loginBtnText.textContent = 'Entrar';
                if (loginSpinner) loginSpinner.style.display = 'none';
            }
        }

        async function handleLogout() {
            try {
                await supabaseClient.auth.signOut();
                
                currentUser = null;
                currentPersonalTrainer = null;
                clients = [];
                evaluations = [];
                workouts = [];
                appointments = [];
                selectedExercises = [];
                recentActivities = [];
                
                document.getElementById('main-app').classList.add('hidden');
                document.getElementById('auth-screen').classList.remove('hidden');
                
                const loginEmail = document.getElementById('login-email');
                const loginPassword = document.getElementById('login-password');
                if (loginEmail) loginEmail.value = '';
                if (loginPassword) loginPassword.value = '';
                
                showNotification('Logout realizado com sucesso!', 'success');
            } catch (error) {
                console.error('Error logging out:', error);
                showNotification('Erro ao fazer logout: ' + error.message, 'error');
            }
        }

        function loadDashboard() {
            const ctx = document.getElementById('evolutionChart');
            if (!ctx) return;
            
            if (window.dashboardChart) window.dashboardChart.destroy();
            
            const last6Months = [];
            const now = new Date();
            for (let i = 5; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                last6Months.push({
                    label: date.toLocaleDateString('pt-BR', { month: 'short' }),
                    month: date.getMonth(),
                    year: date.getFullYear()
                });
            }
            
            const clientsData = last6Months.map(month => {
                return clients.filter(c => {
                    const createdDate = new Date(c.created_at);
                    return createdDate.getMonth() === month.month && createdDate.getFullYear() === month.year;
                }).length;
            });
            
            const evalsData = last6Months.map(month => {
                return evaluations.filter(e => {
                    const createdDate = new Date(e.created_at);
                    return createdDate.getMonth() === month.month && createdDate.getFullYear() === month.year;
                }).length;
            });
            
            window.dashboardChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last6Months.map(m => m.label),
                    datasets: [
                        {
                            label: 'Novos Clientes',
                            data: clientsData,
                            borderColor: '#1B5E20',
                            backgroundColor: 'rgba(27, 94, 32, 0.1)',
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: 'Avaliações',
                            data: evalsData,
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            tension: 0.3,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Global functions for inline calls
        window.updateExercise = updateExercise;
        window.removeExercise = removeExercise;
        window.openWorkoutModal = openWorkoutModal;

        // Check for existing session on page load
        async function checkSession() {
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                
                if (session && session.user) {
                    currentUser = session.user;
                    
                    const personalTrainer = await getPersonalTrainerByEmail(session.user.email);
                    if (personalTrainer) {
                        currentPersonalTrainer = personalTrainer;
                        
                        document.getElementById('auth-screen').classList.add('hidden');
                        document.getElementById('main-app').classList.remove('hidden');
                        
                        await loadUserData();
                        setupCalculator();
                        loadDashboard();
                    }
                }
            } catch (error) {
                console.error('Error checking session:', error);
            }
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize theme
            initializeTheme();

            // Auth event listeners
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const email = document.getElementById('login-email')?.value.trim();
                    const password = document.getElementById('login-password')?.value;
                    if (email && password) {
                        await handleLogin(email, password);
                    }
                });
            }

            // Navigation
            const navLinks = document.querySelectorAll('.nav-link');
            const sections = document.querySelectorAll('.app-section');
            const pageTitle = document.getElementById('page-title');

            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    navLinks.forEach(l => l.classList.remove('bg-green-700'));
                    this.classList.add('bg-green-700');
                    
                    sections.forEach(section => section.classList.remove('active'));
                    
                    const sectionId = this.id.replace('nav-', 'section-');
                    const targetSection = document.getElementById(sectionId);
                    if (targetSection) targetSection.classList.add('active');
                    
                    if (pageTitle) pageTitle.textContent = this.querySelector('span')?.textContent || '';

                    if (window.innerWidth < 1024) {
                        const sidebar = document.querySelector('.sidebar');
                        if (sidebar) sidebar.classList.remove('active');
                    }
                });
            });

            const settingsBtn = document.getElementById('settings-btn');
            if (settingsBtn) {
                settingsBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    navLinks.forEach(l => l.classList.remove('bg-green-700'));
                    this.classList.add('bg-green-700');
                    sections.forEach(s => s.classList.remove('active'));
                    const settingsSection = document.getElementById('section-settings');
                    if (settingsSection) settingsSection.classList.add('active');
                    if (pageTitle) pageTitle.textContent = 'Configurações';
                    
                    if (window.innerWidth < 1024) {
                        const sidebar = document.querySelector('.sidebar');
                        if (sidebar) sidebar.classList.remove('active');
                    }
                });
            }

            // Sidebar toggle
            const toggleSidebar = document.getElementById('toggle-sidebar');
            const closeSidebar = document.getElementById('close-sidebar');
            const sidebar = document.querySelector('.sidebar');

            if (toggleSidebar && sidebar) {
                toggleSidebar.addEventListener('click', function() {
                    sidebar.classList.add('active');
                });
            }

            if (closeSidebar && sidebar) {
                closeSidebar.addEventListener('click', function() {
                    sidebar.classList.remove('active');
                });
            }

            // Theme toggle
            const themeToggle = document.getElementById('theme-toggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', function() {
                    const body = document.body;
                    const html = document.documentElement;
                    const icon = this.querySelector('i');
                    
                    if (body.classList.contains('light')) {
                        body.classList.remove('light');
                        body.classList.add('dark');
                        html.classList.add('dark');
                        if (icon) {
                            icon.classList.remove('fa-moon');
                            icon.classList.add('fa-sun');
                        }
                    } else {
                        body.classList.remove('dark');
                        body.classList.add('light');
                        html.classList.remove('dark');
                        if (icon) {
                            icon.classList.remove('fa-sun');
                            icon.classList.add('fa-moon');
                        }
                    }
                });
            }

            // Logout
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    showConfirmDialog('Tem certeza que deseja sair?', handleLogout);
                });
            }

            // Client modal
            const addClientBtn = document.getElementById('add-client-btn');
            const closeClientModal = document.getElementById('close-client-modal');
            const cancelClientBtn = document.getElementById('cancel-client-btn');
            const clientForm = document.getElementById('client-form');

            if (addClientBtn) addClientBtn.addEventListener('click', () => openClientModal());
            if (closeClientModal) closeClientModal.addEventListener('click', () => {
                const modal = document.getElementById('client-modal');
                if (modal) modal.classList.remove('active');
            });
            if (cancelClientBtn) cancelClientBtn.addEventListener('click', () => {
                const modal = document.getElementById('client-modal');
                if (modal) modal.classList.remove('active');
            });
            if (clientForm) clientForm.addEventListener('submit', handleClientSave);

            // Client detail modal
            const backToClients = document.getElementById('back-to-clients');
            const clientDetailEditBtn = document.getElementById('client-detail-edit-btn');
            const clientDetailNewEvalBtn = document.getElementById('client-detail-new-eval-btn');
            const clientDetailNewWorkoutBtn = document.getElementById('client-detail-new-workout-btn');

            if (backToClients) {
                backToClients.addEventListener('click', () => {
                    const modal = document.getElementById('client-detail-modal');
                    if (modal) modal.classList.remove('active');
                    currentClientId = null;
                });
            }

            if (clientDetailEditBtn) {
                clientDetailEditBtn.addEventListener('click', () => {
                    if (currentClientId) {
                        openClientModal(currentClientId);
                        const detailModal = document.getElementById('client-detail-modal');
                        if (detailModal) detailModal.classList.remove('active');
                    }
                });
            }

            if (clientDetailNewEvalBtn) {
                clientDetailNewEvalBtn.addEventListener('click', () => {
                    if (currentClientId) {
                        const clientSelect = document.getElementById('client');
                        if (clientSelect) clientSelect.value = currentClientId;
                        
                        const navCalculator = document.getElementById('nav-calculator');
                        if (navCalculator) navCalculator.click();
                        
                        const detailModal = document.getElementById('client-detail-modal');
                        if (detailModal) detailModal.classList.remove('active');
                    }
                });
            }

            if (clientDetailNewWorkoutBtn) {
                clientDetailNewWorkoutBtn.addEventListener('click', () => {
                    if (currentClientId) {
                        openWorkoutModal(null, currentClientId);
                        const detailModal = document.getElementById('client-detail-modal');
                        if (detailModal) detailModal.classList.remove('active');
                    }
                });
            }

            // Client detail tabs
            document.querySelectorAll('.client-detail-tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.client-detail-tab-btn').forEach(b => {
                        b.classList.remove('border-green-600', 'text-green-600');
                        b.classList.add('border-transparent', 'text-gray-500');
                    });
                    this.classList.add('border-green-600', 'text-green-600');
                    this.classList.remove('border-transparent', 'text-gray-500');
                    
                    document.querySelectorAll('.client-tab').forEach(tab => tab.classList.remove('active'));
                    const targetTab = document.getElementById(`client-tab-${this.dataset.tab}`);
                    if (targetTab) targetTab.classList.add('active');
                });
            });

            // Profile form
            const profileForm = document.getElementById('profile-form');
            if (profileForm) profileForm.addEventListener('submit', handleProfileSave);

            // Profile image upload
            const profileImageInput = document.getElementById('profile-image-input');
            if (profileImageInput) {
                profileImageInput.addEventListener('change', async function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        await handleProfileImageUpload(file);
                    }
                });
            }

            // Export functions
            const exportDataBtn = document.getElementById('export-data-btn');
            if (exportDataBtn) {
                exportDataBtn.addEventListener('click', () => {
                    try {
                        const allData = {
                            clients: clients,
                            evaluations: evaluations,
                            workouts: workouts,
                            appointments: appointments
                        };
                        
                        const dataStr = JSON.stringify(allData, null, 2);
                        const dataBlob = new Blob([dataStr], {type: 'application/json'});
                        const url = URL.createObjectURL(dataBlob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `shapefit-backup-${new Date().toISOString().slice(0,10)}.json`;
                        link.click();
                        URL.revokeObjectURL(url);
                        
                        showNotification('Dados exportados com sucesso!', 'success');
                    } catch (error) {
                        showNotification('Erro ao exportar dados: ' + error.message, 'error');
                    }
                });
            }

            // Client reports functions
            const generateClientReportBtnFilter = document.getElementById('generate-client-report-btn-filter');
            const generateClientReportBtn = document.getElementById('generate-client-report-btn');
            const exportClientDataBtn = document.getElementById('export-client-data-btn');

            if (generateClientReportBtnFilter) {
                generateClientReportBtnFilter.addEventListener('click', () => {
                    if (!currentClientId) {
                        showNotification('Selecione um cliente primeiro', 'error');
                        return;
                    }
                    
                    const client = clients.find(c => c.id === currentClientId);
                    const clientEvals = evaluations.filter(e => e.client_id === currentClientId);
                    
                    if (clientEvals.length === 0) {
                        showNotification('Cliente não possui avaliações para gerar relatório', 'warning');
                        return;
                    }
                    
                    generatePDFReport(client, clientEvals[0]);
                });
            }

            if (generateClientReportBtn) {
                generateClientReportBtn.addEventListener('click', () => {
                    if (!currentClientId) {
                        showNotification('Selecione um cliente primeiro', 'error');
                        return;
                    }
                    
                    const client = clients.find(c => c.id === currentClientId);
                    const clientEvals = evaluations.filter(e => e.client_id === currentClientId);
                    
                    if (clientEvals.length === 0) {
                        showNotification('Cliente não possui avaliações para gerar relatório', 'warning');
                        return;
                    }
                    
                    generatePDFReport(client, clientEvals[0]);
                });
            }

            if (exportClientDataBtn) {
                exportClientDataBtn.addEventListener('click', () => {
                    if (!currentClientId) {
                        showNotification('Selecione um cliente primeiro', 'error');
                        return;
                    }
                    
                    const client = clients.find(c => c.id === currentClientId);
                    const clientData = evaluations.filter(e => e.client_id === currentClientId);
                    
                    if (clientData.length === 0) {
                        showNotification('Cliente não possui dados para exportar', 'warning');
                        return;
                    }
                    
                    exportToExcel(clientData, `dados-${client.name.replace(/\s+/g, '-')}`);
                });
            }

            // Workout modal
            const createWorkoutBtn = document.getElementById('create-workout-btn');
            const closeWorkoutModal = document.getElementById('close-workout-modal');
            const cancelWorkoutBtn = document.getElementById('cancel-workout-btn');
            const workoutForm = document.getElementById('workout-form');

            if (createWorkoutBtn) createWorkoutBtn.addEventListener('click', () => openWorkoutModal());
            if (closeWorkoutModal) closeWorkoutModal.addEventListener('click', () => {
                const modal = document.getElementById('workout-modal');
                if (modal) modal.classList.remove('active');
            });
            if (cancelWorkoutBtn) cancelWorkoutBtn.addEventListener('click', () => {
                const modal = document.getElementById('workout-modal');
                if (modal) modal.classList.remove('active');
            });
            if (workoutForm) workoutForm.addEventListener('submit', handleWorkoutSave);

            // Workout templates
            document.querySelectorAll('.workout-template').forEach(template => {
                template.addEventListener('click', function() {
                    const type = this.dataset.type;
                    openWorkoutModal();
                    const workoutType = document.getElementById('workout-type');
                    const workoutName = document.getElementById('workout-name');
                    
                    if (workoutType) workoutType.value = type;
                    if (workoutName) workoutName.value = `Treino de ${type}`;
                });
            });

            // Appointment modal
            const addAppointmentBtn = document.getElementById('add-appointment-btn');
            const closeAppointmentModal = document.getElementById('close-appointment-modal');
            const cancelAppointmentBtn = document.getElementById('cancel-appointment-btn');
            const appointmentForm = document.getElementById('appointment-form');

            if (addAppointmentBtn) addAppointmentBtn.addEventListener('click', () => openAppointmentModal());
            if (closeAppointmentModal) closeAppointmentModal.addEventListener('click', () => {
                const modal = document.getElementById('appointment-modal');
                if (modal) modal.classList.remove('active');
            });
            if (cancelAppointmentBtn) cancelAppointmentBtn.addEventListener('click', () => {
                const modal = document.getElementById('appointment-modal');
                if (modal) modal.classList.remove('active');
            });
            if (appointmentForm) appointmentForm.addEventListener('submit', handleAppointmentSave);

            // Calendar navigation
            const prevMonth = document.getElementById('prev-month');
            const nextMonth = document.getElementById('next-month');
            const todayBtn = document.getElementById('today-btn');

            if (prevMonth) {
                prevMonth.addEventListener('click', () => {
                    calendarDate.setMonth(calendarDate.getMonth() - 1);
                    renderCalendar();
                });
            }

            if (nextMonth) {
                nextMonth.addEventListener('click', () => {
                    calendarDate.setMonth(calendarDate.getMonth() + 1);
                    renderCalendar();
                });
            }

            if (todayBtn) {
                todayBtn.addEventListener('click', () => {
                    calendarDate = new Date();
                    renderCalendar();
                });
            }

            // Modal close on escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal.active').forEach(modal => modal.classList.remove('active'));
                }
            });

            // Modal close on click outside
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });

            // Check for existing session
            checkSession();

            // Credenciais de demonstração
            setTimeout(() => {
                const loginEmail = document.getElementById('login-email');
                const loginPassword = document.getElementById('login-password');
                
                if (loginEmail) loginEmail.value = '';
                if (loginPassword) loginPassword.value = '';
            }, 500);
        });
    </script>
</body>
</html>
